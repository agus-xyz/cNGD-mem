%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Design Study}

\begin{FraseCelebre}
\begin{Frase}
Surf it, scroll it, pause it, click it,\\
cross it, crack it, switch - update it\\
name it, rate it, tune it, print it,\\
scan it, send it, fax - rename it\\
%Touch it, bring it, pay it, watch it
\end{Frase}
\begin{Fuente}
Thomas \& Guy-Manuel, Daft Punk
\end{Fuente}
\end{FraseCelebre}

\begin{resumen}
In this chapter the platform design is described. Design decisions, specifications, schemes and needed calculations will be exposed.
Detailled characterstics of any chosen component, including microcontroller, radio interfaces, power-supply options will be provided.
\end{resumen}



%-------------------------------------------------------------------
\section{Global Hardware Description}
%-------------------------------------------------------------------
\label{cap4:sec:hardwareDescription}
%-------------------------------------------------------------------

Attending to the already described requirements and the conclusions obtained from the \ac{FCD} review, the following decisions have been taken before proceeding with the design process.

The whole system is thought as teaser. Consisting on different fitteable modules giving flexibility to the scheme. Main module, \ac{CNGD}, is cornerstone. \ac{CNGD} suposes the main platform of the design, hosting the power supply and control system, possibities to embbed up to three \ac{RI}s, a control core unit, and other interfacing possibilites studied further on. As part of this modular design, the interfaces \ac{CNGD} hosts open possibilities to new extension board implementations through a pair of headers. These attachable boards, following the popular way these such of devices are called, will be referred as shields.  

Offering the chance of embbedding up to three \ac{RI}s, the device could access three different frequency bands over the spectrum, fulfilling one of the desired requirements described in section \ref{cap3:sec:systemRequirements}. The chosen operation frecuencies in our design are 434 MHz, 868 MHz and 2.4 GHz. Coupling the \ac{ISM} bands in most part of Europe. This bands are preferred for \ac{WSN} due to the data-rate, transmission power and transmission range parameters they offer. This configuration places the device on the bound of complexity and cost. At the same time, this feature is essential for a \ac{CWSN} proper investigation, giving radio communication opportunities not provided by any other similar device so far. Moreover, a full exploitation of the firwmware described in \ref{cap3:sec:halreview} can be done, since it offers an integrated MiWi$^{TM}$ stack for three \ac{RI}s.

The three \ac{RI} are based on the IEEE 802.15.4 standard for \ac{WPAN}s, commonly used in \ac{WSN}. Specifically, the set of interfaces will operate under MiWi$^{TM}$ or MiWi$^{TM}$P2P protocol. They both are proprietary protocols designed by Microchip Technology that uses small, low-power digital radios. It is open source option designed for low data transmission rates (up to 250Kbit/s) and short distance (up to 100 without obstacles), cost constrained networks. Main difference between MiWi$^{TM}$ and ZigBee$^{TM}$\footnote{A very popular wireless IEEE 802.15.4 compatible protocol employed at \ac{WSNs}.} is complexity. MiWi$^{TM}$ offers a much more simple operation, resulting in a lighter implementation. The size required for the MiWi$^{TM}$ stack is  3-10 KB on the ROM depending on the node role while ZigBee$^{TM}$ takes 20-40 KB. MiWi$^{TM}$ is free of cost and it does not require for licenses adquisition as long as Microchip components are used, in fact Microchip requires the use of MiWi$^{TM}$ for its products. The global design becomes simpler and more omogeneus sharing a common communication protocol for all the \ac{RI}s.

Since there were not found compatible and suitable size commercial options for 868 MHz and 434 MHZ \ac{RI}s, a custom full implementation of these interfaces was required. $\mu$Trans434/868 from now on. These \ac{RI}s are based on the MRF49XA Microchip transceiver and its full description is taken at section \ref{cap4:sec:transceivers}. Option at 2.4 GHz is a MRF24J40MA module.

For this work a pair of shields were designed. A simple serial communication complement that links one \ac{UART} and a classic rs232 interface over the so-called rs232SHIELD. This interface would facilitate the software development since the firmware just allowed debugging through the \ac{UART} at first and it is described in section \ref{cap4:sec:rs232shield}. A battery charger Ni-Mh and Ni-Cd was also designed and implemented as a utility for portability options. The device was called as chargerSHIELD. 

%-------------------------------------------------------------------
\section{Altium Designer}
%-------------------------------------------------------------------
\label{cap4:sec:altiumDesigner}
%-------------------------------------------------------------------

For the whole designing task, a \ac{EDA}\footnote{Electronic design automation is a category of software tools for designing electronic systems such as printed circuit boards and integrated circuits.} software will be use. Altium Designer, being one of the most important \ac{EDA} softwares, is commonly used by researchers at \ac{LSI}. All the \ac{CNGD} design process is carried through Altium Designer on its version 10. 

Altium Designer is software package for printed circuit board, \ac{FPGA} and embedded software design, and associated library and release management automation. It is developed and marketed by Altium Limited of Australia.

\figura{Bitmap/Capitulo4/altium}{width=.3\textwidth}{fig:cap4:altium}%
{Altium Designer logo}

Despite the amount of functionalities offered by Altium Designer the two main options needed for this project are schematic capture, for circuit edition, and \ac{PCB} design, for subsequent layout deployment.

Options provided by the schematic capture module, required for the design task, includes:
%DESARROLLAR CARACTERISTICAS **************************************************************************************
\begin{itemize}
	\item Component library management. 
	\item \ac{SPICE} mixed-signal circuit simulation.
      	\item Netlist export. 
     	\item Reporting and BoM facilities.
	\item Multi-channel, hierarchical schematics and design re-use.
\end{itemize}

On the other hand, required option from the \ac{PCB} design module are:
\begin{itemize}
	\item Component footprint library management.
   	\item Component placement.
   	\item Manual trace routing, with support for multi-trace routing. 
   	\item Interactive 3D editing of the board and MCAD export to STEP
   	\item Manufacturing files generation with support for Gerber formats
\end{itemize}

%-------------------------------------------------------------------
\subsection{agus lib}
%-------------------------------------------------------------------
For the accomplish the full design of the platform over Altium Designer, a component library with all the requried but not found models was set all along the design proccess.

As said, the library includes models from all those components needed but not found as well as modifications of existing models in order tu suit the design criteria. Every contained model embbeds schematic, footprint and 3D model. 3D models are useful for 3D rendering and proper hardware fitting checkings purposes.

ANEXAR ¿libreria? **********************************************


%-------------------------------------------------------------------
\section{Transceivers - $\mu$Trans 434/868}
%-------------------------------------------------------------------
\label{cap4:sec:transceivers}
%-------------------------------------------------------------------

The chosen firmware for our platform gives support for MRF49XA modules over 434 MHz and 868 MHz bands. Specifically, the modules used during the firmware development were the MRF49XA PICtail$^{TM}$ Daughter Board**********REF, whose picture is seen in. This board is a demonstration and development daughter board for the MRF49XA ISM Band Sub-GHz RF Transceiver. The board can plug into a fitteable header, which makes it unsuitable for a reduced size and robust \ac{WSN} design. It either accepts connection to external antennas, which is a desirable requirement.

\figura{Bitmap/Capitulo4/pictail}{width=.4\textwidth}{fig:cap4:pictail}%
{MRF49XA PICtail$^{TM}$ Daughter Board}

No commercial \ac{RI}s were found based on the MRF49XA transceiver showing a reduced size. The implementation of a MRF49XA-based \ac{RI} module, suitable on size and features for our desing was required.  

Previous to the \ac{CNGD} designing, which will embbeds the $\mu$Trans 434/868, the design of these \ac{RI}s was needed.

%-------------------------------------------------------------------
\subsection{Description}
%-------------------------------------------------------------------
MRF49XA is a low-power fully integrated Sub-GHz RF transceiver. An ideal choice for low-cost, high-volume, low data rate (< 256 kbps), two-way, short range wireless applications. It can operate in the unlicensed 434, 868 and 915 MHz frequency bands. The transceiver is integrated with different Sleep modes and an internal wake-up timer to reduce the overall current consumption. The device operates in the low-voltage range of 2.2V to 3.8V, and in Sleep mode, it operates at a very low-current state, typically 0.3 $\mu$A.

Further details about consumption on different modes and other features are given below.
\begin{itemize}
	\item Modulation Technique: FSK with \ac{FHSS} capability. 
	\item Differential RF Input/Output:
	\begin{itemize}
		\item -110 dBm Typical sensitivity with 0 dBm maximum input level.
		\item +7 dBm Typical transmit output power.
	\end{itemize}
	\item Maximum supportted data rates:
	\begin{itemize}
		\item Digital mode 115.2 kbps.
		\item Analog mode 256 kbps.
	\end{itemize}
	\item Current Consumption:
	\begin{itemize}
		\item TX. 434MHz, I = 23 mA at 7 dBm. 868MHz, I = 24 mA at 5 dBm.
		\item RX. 433MHz, I = 11 mA. 868MHz, I = 12 mA.
		\item Idle. 1.2 mA (Max).
	\end{itemize}	
	\item Temperature range of operation from -40$^{\circ}$	to 85$^{\circ}$.
	\item Other functionalities: \ac{DQI} data, \ac{RSSI} data.
\end{itemize}

This transceiver is not IEEE 802.15.4 compatible since the number of channels it provides depends on the configured bit-rate, whereas the standard sets a fix number of channels. MRF49XA supports Microchip proprietary sub-GHz wireless protocols. 

Due to the \ac{RSSI} and \ac{DQI} indicators, the transceiver is able to carry out \ac{ED} scans over the supported frequencies to operate
on the least-noisy channel. This sensing capability is crucial for \ac{CR} tasks.

\figura{Bitmap/Capitulo4/mrf49xapinout}{width=.6\textwidth}{fig:cap4:mrf49xapinout}%
{MRF49XA pin diagram}

Figure \ref{fig:cap4:mrf49xapinout} shows the MRF49XA pin diagram, a full description of each pin is given here: 

\begin{itemize}
	\item 1. \emph{SDI}. Digital Input. Serial data input interface to MRF49XA (\ac{SPI} input signal).
	\item 2. \emph{SCK}. Digital Input. Serial clock interface (\ac{SPI} clock).
	\item 3. \emph{nCS}. Digital Input. Serial interface chip select (\ac{SPI} chip/device select).
	\item 4. \emph{SDO}. Digital Output. Serial data output interface from MRF49XA (\ac{SPI} output signal).
	\item 5. \emph{IRO}. Digital Output. Interrupt Request Output: Receiver generates an active-low interrupt request for the 					microcontroller on the determinated events. Some of this events are:
		\begin{itemize}
		\item Dataflow control registers notifications. 
		\item Negative pulse on interrupt input pin.
		\item Wake-up timer time-out.
		\item Supply voltage below the preprogrammed value is detected.
		\item Power-on Reset.
		\end{itemize}

	\item 6. \emph{FSEL}. Digital Input/Output. \ac{FIFO} Select: Selects the FIFO and the first bit appears on the next clock when reading 						the Receiver FIFO Read Register. The FSEL pin has an internal pull-up resistor. This pin must be 						``high'' when the TX register is enabled. In order to achieve minimum current consumption, keep this pin 						``high'' in Sleep mode. This pin could provide other functionalities not used for our design.
	\item 7. \emph{FINT}. Digital Input/Output. \ac{FIFO} Interrupt: When the FIFO enable bit of General Configuration Register is 			enabled, this pin acts as a FIFO full interrupt, indicating that the FIFO has be en filled to its preprogrammed limit. This pin 		could provide other functionalities not used for our design.
	\item 8. \emph{CLKOUT}. Digital Output. Clock Output: The transceiver's clock output can be used by the host microcontroller as a clock 				source.
	\item 9. \emph{RFXTL}. Analog Input. RF Crystal: This pin is connected to a 10 MHz series crystal or to an external oscillator 				reference. The crystal is used as a reference for the \ac{PLL} which generates the local oscillator frequency. It is 				possible to ``pull'' the crystal to the accurate frequency by changing the load capacitor value.
	\item 10. \emph{nRESET}. Digital Input/Output. Active-low hardware pin. This pin has an open-drain Reset output with internal pull-up 					and input buffer.
	\item 11. \emph{Vss}. Ground. Ground reference.
	\item 12. \emph{RFP}. RF. Input/Output Differential RF input/output (+).
	\item 13. \emph{RFN}. RF. Input/Output Differential RF input/output (-).
	\item 14. \emph{VDD}. Power. RF power supply. Bypass with a capacitor close to the pin. 
	\item 15. \emph{RSSIO}. Analog Input/Output. Received Signal Strength. Indicator Output: The analog RSSI output is used to determine the 					signal strength. The response and settling time depends on the external filter capacitor.
	\item 16. \emph{nINT}. Digital Input/Output. Interrupt: This pin can be configured as an active-low external interrupt to the device. 			If a logic '0' is applied to this pin, it causes the IRO pin to toggle, signaling an interrupt to the external microcontroller. 		The source of interrupt can be determined by reading the first four bits of STSREG. This pin can be used to wake-up the device 			from Sleep. This pin could provide other functionalities not used for our design.
\end{itemize}

An internal transmit/receive switch combines the transmitter and receiver circuits into differential RFP and RFN pins. These pins are connected to the impedance matching circuitry (balun) and to the external antenna connected to the device.

The quality of the data is checked or validated using the RSSI and DQI blocks built into the transceiver. Data is buffered in transmitter registers and receiver \ac{FIFO}s. The Automatic Frequency Control feature allows the use of a low-accuracy and low-cost crystal. The transceiver is controlled via a 4-wire SPI, interrupt (INT and IRO), FSEL, FINT and RESET pins. The interface between the microcontroller and MRF49XA is shown in Figure \ref{fig:cap4:mrf49xainterface}.

\figura{Bitmap/Capitulo4/mrf49xainterface}{width=0.5\textwidth}{fig:cap4:mrf49xainterface}%
{Microcontroller to MRF49XA interface}

The complete design of the $\mu$Trans 434/868 is based on the implementation guidelines provided my Microchip at MRF49XA datasheet. The only difference between 434 Mhz and 868 Mhz version of the $\mu$Trans is the impedance matching circuitry facing the external antenna. The components composing it are different for each frequency band, values are specified at table \ref{tab:cap4:balunvalues}. 

Current is bypassed through a capacitor and supplies the MRF49XA, a power indication led is included in the design. A 10 MHz clock carries out the timming tasks. An impedance matching ciruitry composed by inductors and capacitors interfaces the MRF49XA and the antenna. The \ac{RI} hosts a 50$\Omega$ connector to which connect the corresponding antenna.

The designed module allow access to some of the MRF49XA pins, not all of them. The ports accesible at the \ac{RI} are Interrupt (nINT), Interrupt Request Output, \ac{SPI} ports, \ac{FIFO} select, \ac{FIFO} interrupt, and reset. These ports enable full functionality of the MRF49XA and rest of available pins are found dispensable.


%-------------------------------------------------------------------
\subsection{Schematics}
%-------------------------------------------------------------------

\figura{Bitmap/Capitulo4/mtransschematic}{width=.8\textwidth}{fig:cap4:mtransschematic}%
{$\mu$Trans 434/868 schematic}

\begin{table}[!h]
\centering
\scalebox{0.8}{
\begin{tabular}{||c|c|c|c|c|c|c|c||}
\hline
Freq & C1 & L1 & L2 & L3 & C5 & C6 & C7 \\ \hline
434 MHz & 220 pF & 390 nH & 33 nH & 47 nH & 2.7pF & 68 pF & 5.1 pF \\ \hline
868 MHz & 47 pF & 100 nH & 8.2 nH & 22 nH & 1.2 pF & 27 pF & 2.7 pF \\ \hline
\end{tabular}}
\caption{Values for balun components at different frequency bands.
\label{tab:cap4:balunvalues}}
\end{table}

 
\figura{Bitmap/Capitulo4/mtransmodel}{width=.4\textwidth}{fig:cap4:mtransmodel}%
{$\mu$Trans 434/868 component model for use}

%-------------------------------------------------------------------
\section{Main Board - cognitiveNextGenerationDevice}
%-------------------------------------------------------------------
\label{cap4:sec:cNGD}
%-------------------------------------------------------------------

\figura{Bitmap/Capitulo4/modelcngd}{width=.7\textwidth}{fig:cap4:modelcngd}%
{Architecture Model of the cNGD}

%-------------------------------------------------------------------
\subsection{Description}
%-------------------------------------------------------------------
As it was said, \ac{CNGD} suposes the main part of the design, it hosts main capabilities for computation, power supply, and connectivity for the platform. It has being designed seeking simplicity and functionality.

The computation unit is located at the microcontroller, taking control over the rest of modules and running the software. This microcontroller can be programmed through its PGE port thanks to a PGE module that interfaces it.  

As part of the main goal, the firmware reviewed in section \ref{cap3:sec:halreview} will be used. It supposes an aproach to the requirements achievement since it gives support for three interfaces, it supposes a reduction on the computation load and therefore, on the needed resources and power consumption. Moreover it will facilitate the development, offering a stable firmware version to work over and avoiding software development tasks. This fact will force the design to keep one architecture compatible with the firmware, hence a 32-bit Microchip PIC is required as microcontroller.

\ac{CNGD} has been designed to attach up to three \ac{RI}s. Communication and control over these \ac{RI}s is made through \ac{SPI}s and a few more control signal described further on. 

Power supply will be able to take place through three ways, a $\mu$USB, a block terminal and a DC terminal. Two first options will take a 5V supply, whereas the third one will take 3.3V. This last option is thought to be supplied by a battery. $\mu$USB option serves as serial communication chance, and since \ac{USB} provides 5V power supply, this is employed. A second 5V supplying connector opens possibilites to not compulsory use\ac{USB}. A software-driven power supply system to the \ac{RI}s allows the application to control the power supply to these modules. 

The device offers serial communication through the already named $\mu$USB options. Moreover, it gives access to to different peripherals through a pair of 20-pin headers. The list of approachable peripherals and pins covers battery connection (for charging purposes), \ac{GPIO}s, \ac{MCLR} pin, external interruptions, analogue inputs, \ac{USB}, Ethernet module, I2C bus, \ac{UART}s and \ac{SPI}. These option gives flexibility, modularity and versatility to the device. It provides possibilities for multiple kind of applications and open the design to new implementations and extensions for a particular aplications. In addition, three leds and two push buttons give chance to the user to, somewhat, interact with the platform if required. 
   
%-------------------------------------------------------------------
\subsection{Schematics}
%-------------------------------------------------------------------

\afterpage{%
\clearpage\clearpage 

\begin{figure}[t]
\centering
\includegraphics[width=0.7\textwidth]{Imagenes/Vectorial/Todo.pdf}
\caption{Caption 1
\label{fig:cap4:prueba}}
\end{figure}

\begin{figure}[h]
\includegraphics[width=0.7\textwidth]{Imagenes/Vectorial/Todo.pdf}
\caption{Caption 2
\label{fig:cap4:prueba2}}
\end{figure}

\begin{figure}[h]
\includegraphics[width=0.7\textwidth]{Imagenes/Vectorial/Todo.pdf}
\caption{Caption 3
\label{fig:cap4:prueba3}}
\end{figure}

\begin{figure}[h]
\includegraphics[width=0.7\textwidth]{Imagenes/Vectorial/Todo.pdf}
\caption{Caption 4
\label{fig:cap4:prueba4}}
\end{figure}

}


\figura{Bitmap/Capitulo4/schematic}{width=1.1\textwidth}{fig:cap4:gneralschematic}%
{cNGD general schematic}

\figura{Bitmap/Capitulo4/MCU}{width=1.1\textwidth}{fig:cap4:mcuschematics}%
{Microcontroller specific schematic}

\figura{Bitmap/Capitulo4/powersupply}{width=1.1\textwidth}{fig:cap4:powersupplyschematic}%
{Power supply system schematic}

\figura{Bitmap/Capitulo4/headers}{width=1.1\textwidth}{fig:cap4:headerschematic}%
{Expansion header system schematic}

%-------------------------------------------------------------------
\subsection{Microcontroller}
%-------------------------------------------------------------------
Core unit is a PIC32MX675F256L, a midrange 100-pin microcontroller from the mentioned 32-bit PIC family. Being the simplest of the options meeting memory performance and peripherals minimum requirements (Table \ref{cap3:tab:micros}). On the other hand, its 100 pins allow a better access of the peripherals provided. A larger memory version of this, PIC32MX675F512L, is pin compatible to the firstly mentioned. This fact gives the chance to swap among these two \ac{MCU}s if larger memory was needed. Main thecnical features follow:

\begin{itemize}
	\item Operating Voltage Range: 2.3V to 3.6V.
	\item 256/512 KB Flash (PIC32MX675F256L/PIC32MX675F512L). 64KB RAM.
	\item RUN, IDLE, and SLEEP modes. Multiple switchable clock modes for each power mode. Maximum speed is 80 MHz.
	\item Serial Communication Modules allow flexible UART/SPI/I2C configuration. 6 \ac{UART}s, 4 \ac{SPI}s, and 5 {I2C}s included.  
	\item USB 2.0 On-The-Go peripheral with integrated PHY.
	\item 10/100 Ethernet MAC with MII/RMII\footnote{Media Independent Interface and Reduced Media Independent Interface are standard 			interfaces used to connect a Fast Ethernet \ac{MAC}-block to a PHY chip.} interfaces. 
	\item 2 wire programming and debugging interface.
	\item Five 16-bit Digital Timers embbeded.
	\item 16 channel 10-bit \ac{ADC}. 
\end{itemize}

Figure \ref{fig:cap4:pic32blocks} shows a block diagram of the PIC32 family. Distinct 32-bit buses for peripherals and system can be observed. Moreover, \ac{DMA}, \ac{RAM}, and flash controllers, together with external modules take place on it.

\figura{Vectorial/Todo}{width=0.8\textwidth}{fig:cap4:pic32blocks}%
{PIC32 family block diagram}

The whole microcontroller can be divided into for blocks: core, memory, integration system and peripherals:

\begin{itemize}
	\item The main core is based on a \ac{RISC} MIPS M4K. This module takes control over the system. It controls the peripherals and execute 			the programmed code.

	\item A further observation into the memory system allows differenciate among Flash, \ac{RAM}, registers, and boot flash. The system 			load the data on a cache memory and prefetch the instructions. Figure \ref{} shows the block diagram of the prefetch module.

\figura{Vectorial/Todo}{width=0.8\textwidth}{fig:cap4:pic32cachemodule}%
{Prefetch cache module block diagram.}	

	\item Integration system is compound by the set of modules needed to make work the core and peripherals. These are interrupt control, 			oscillator system, reset, watchdog timer and power-up timer. For detailed explanation of each module consult the microcontroller 			manual \cite{}**********************************.

	\item Peripherals are a set of independent modules oriented to perform specific tasks. Here it is described a brief description of the 			main peripherals and the use they receive in the system: 

	\begin{itemize}
		\item \emph{\ac{SPI}}. The SPI module is a synchronous serial interface that is useful for communicating with external 					peripherals and other microcontroller devices. These peripheral devices may be serial \ac{EEPROM}, shift 					registers, display drivers, etc. 

				At \ac{CNGD}, three \ac{SPI}s are used to set communication with the \ac{RI}s. Another \ac{SPI} is outputed to 					the expansion headers for general purposes.

				
		\item \emph{\ac{UART}}. This peripheral is a serial I/O module. The \ac{UART} is a full-duplex, asynchronous communication
				 channel that communicates with peripheral devices and personal computers through protocols, such as RS-232, 					RS-485, LIN 1.2 and \ac{IRDA}.

				Two \ac{UART} modules are available at the expansion headers. RS232Shield described at section \ref{cap4:sec:rs232shield} use one of this modules to set an RS-232 serial interface.

		\item \emph{\ac{USB} \ac{OTG}}. The \ac{USB} module contains analog and digital components to provide a \ac{USB} 2.0
			full-speed and low-speed embedded Host, full-speed Device or \ac{OTG} implementation with a minimum of external 			components. 				
			
			This \ac{USB} peripheral is used to stablish serial communication with other devices, \ac{CNGD} it thought to include 				this serial communication way. Its ease of use, popularity, makes it a good choice for this purpose. Moreover, it is 				interfaced into the expansion headers for other future uses.
	
		\item \emph{\ac{I2C}}. The \ac{I2C} module provides complete hardware support for both Slave and Multi-Master modes of the \ac{I2C} serial communication standard. 
			This module is commonly used to establish communication among sensors and microcontroller. One \ac{I2C} can be accessed 			over the expansion headers.

		\item \emph{TIMERS}. Four synchronous, one asynchronous, 16-bit timers that can operate as a free-running interval timer for 				various timing applications and counting external events.

			This timers, properly configured, will drive in time the firmware operation. This includes, pretty much, all the tasks 				carried out by the node. Timers also must be available to drive in time the application if was required. 

		\item \emph{\ac{ADC}}. It converts a continuous voltage quantity to a digital number that represents the quantity's amplitude. 

			Useful when dealing with sensors offering an analog output signal. The \ac{ADC} included into the microcontroller can be 				accessed from the expansion headers.

		\item \emph{ETHERNET}. The Ethernet controller is a bus master module that interfaces with an off-chip Physical Layer (PHY) to
			implement a comple te Ethernet node in a system.
			
			This module is accessible at the headers. It is essential to stablish 802.11 communications, which is a desirable 				feature for \ac{WSN} coordinator nodes or gateways.

		\item \emph{\ac{GPIO}}. General purpose I/O pins are the simplest of peripherals. They allow the PIC32 MCU to monitor and control
			other devices. Basically, almost every pin at the \ac{MCU} can act as a \ac{GPIO} if no other peripherals are active and 				multiplexed on such pin.

			Several \ac{GPIO}s can be accessed over the headers for general purposes.

		\item \emph{\ac{RTCC}}. It is intended for applications in which accurate time must be maintained for extended periods of time
			with minimal or no CPU intervention. Low-power optimization provides extended battery lifetime while keeping track of 				time.

			This module is essential for accurate timming tasks, which are common in \ac{WSN} for syncronous proccesses over the 				network. Syncronisation helps saving energy since it allows better efficient communication and general operation.
	\end{itemize}  
\end{itemize}

%-------------------------------------------------------------------
\subsubsection{Pinout}
%-------------------------------------------------------------------

{\footnotesize
\begin{longtable}{l l l l l}
% aquí añadimos el encabezado de la primera hoja.
\hline
PIN & TIPO & TIPO 2PERIFERICO & USO \\
\hline \hline
\endfirsthead

% aquí añadimos el encabezado del resto de hojas.
\hline
PIN & TIPO & TIPO 2PERIFERICO & USO \\
\hline \hline
\endhead

% aquí añadimos el fondo de todas las hojas, excepto de la última.
\multicolumn{4}{c}{Follows on next page.}
\endfoot

% aquí añadimos el fondo de la última hoja.
\endlastfoot

% aquí añadimos el cuerpo de la tabla.
1 & RE5 & MiWi & CS* \\ \hline
2 & RE6 & MiWi & Wake \\ \hline
3 & RE7 & MiWi & RST* \\ \hline
4 & SCK2A & U2BTX/RG6WIFI & sck2 \\ \hline
5 & SDI2A & U2ARX/RG7WIFI & sdo2 \\ \hline
6 & SDO2A & U2ATX/RG8WIFI & sdi2 \\ \hline
7 & MCLR* &  & RESET \\ \hline
8 & SS2A* & U2BRX/RG9 &  \\ \hline
9 & VSS &  & TIERRA \\ \hline
10 & VDD &  & ALIMENTACIÓN \\ \hline
11 & Vbuson & RB5USB otg & Control Bomba de Carga \\ \hline
12 & RB4 &  & LED \\ \hline
13 & RB3 &  & LED \\ \hline
14 & RB2 &  & LED \\ \hline
15 & PGEC1 & RB1 & Programador \\ \hline
16 & PGED1 & RB0 & Programador \\ \hline
17 & RB6/AN6 & PGEC2 & libre \\ \hline
18 & RB7/AN7 & PGED2 & libre \\ \hline
19 & AVDD &  & ALIMENTACIÓN \\ \hline
20 & AVSS &  & TIERRA \\ \hline
21 & RB8/AN8 & SS3A* & libre \\ \hline
22 & RB9/AN9 &  & libre \\ \hline
23 & TMS & RB10 & jtag \\ \hline
24 & TDO & RB11 & jtag \\ \hline
25 & VSS &  & TIERRA \\ \hline
26 & VDD &  & ALIMENTACIÓN \\ \hline
27 & TCK & RB12 & jtag \\ \hline
28 & TDI & RB13 & jtag \\ \hline
29 & SCK3A & RB14MiWi & sck3 \\ \hline
30 & RB15 & TULIO & RST* \\ \hline
31 & SDI3A & RF4MiWi & sdo3 \\ \hline
32 & SDO3A & RF5MiWi & sdi3 \\ \hline
33 & USBID & RF3USB otg &  \\ \hline
34 & Vbus & USB otg &  \\ \hline
35 & Vusb & USB otg & Conexión a VCC con Condensador \\ \hline
36 & D- & RG3USB otg &  \\ \hline
37 & D+ & RG2USB otg &  \\ \hline
38 & VDD &  & ALIMENTACIÓN \\ \hline
39 & OSC1 & RC12 & Cristal de cuarzo 8mhz \\ \hline
40 & OSC2 & RC15 & Cristal de cuarzo 8mhz \\ \hline
41 & VSS &  & TIERRA \\ \hline
42 & INT1 & RD8/RTCCWiFi & int* \\ \hline
43 & U1BRX & INT2/SS1A*/RD9RS-232 & UART1B RS-232 RX \\ \hline
44 & INT3 & RD10MiWi & int \\ \hline
45 & RD11 & INT4TULIO & interrupción \\ \hline
46 & INT0 & RD0 &  \\ \hline
47 & SOSCI & RC13 & Cristal de cuarzo 32kHz \\ \hline
48 & SOSCO & RC14/T1CK & Cristal de cuarzo 32kHz \\ \hline
49 & U1BTX & RD1/SCK1ARS-232 & UART1B RS-232 TX \\ \hline
50 & U1ARX & RD2/SDI1ATULIO & UART1A RX \\ \hline
51 & U1ATX & RD3/SDO1ATULIO & UART1A TX \\ \hline
52 & RD4 &  & PULSADOR \\ \hline
53 & RD5 &  & PULSADOR \\ \hline
54 & RD6 &  &  \\ \hline
55 & RD7 &  &  \\ \hline
56 & VDDcore &  & VCC, con dos condensadores \\ \hline
57 & VDD &  & ALIMENTACIÓN \\ \hline
58 & RF0 &  &  \\ \hline
59 & RF1 &  &  \\ \hline
60 & RE0 &  & LED \\ \hline
61 & RE1 & WIFI & CS* \\ \hline
62 & RE2 & WIFI & Hibernate \\ \hline
63 & RE3 & WIFI & WP* \\ \hline
64 & RE4 & WIFI & RST* \\ \hline
65 & INT0 & RD0 &  \\ \hline
66 & SOSCI & RC13 & Cristal de cuarzo 32kHz \\ \hline
67 & SOSCO & RC14/T1CK & Cristal de cuarzo 32kHz \\ \hline
68 & U1BTX & RD1/SCK1ARS-232 & UART1B RS-232 TX \\ \hline
69 & U1ARX & RD2/SDI1ATULIO & UART1A RX \\ \hline
70 & U1ATX & RD3/SDO1ATULIO & UART1A TX \\ \hline
71 & RD4 &  & PULSADOR \\ \hline
72 & RD5 &  & PULSADOR \\ \hline
73 & RD6 &  &  \\ \hline
74 & RD7 &  &  \\ \hline
75 & VDDcore &  & VCC, con dos condensadores \\ \hline
76 & VDD &  & ALIMENTACIÓN \\ \hline
77 & RF0 &  &  \\ \hline
78 & RF1 &  &  \\ \hline
79 & RE0 &  & LED \\ \hline
80 & RE1 & WIFI & CS* \\ \hline
81 & RE2 & WIFI & Hibernate \\ \hline
82 & RE3 & WIFI & WP* \\ \hline
83 & RE4 & WIFI & RST* \\ \hline
84 & RE4 & WIFI & RST* \\ \hline
85 & INT0 & RD0 &  \\ \hline
86 & SOSCI & RC13 & Cristal de cuarzo 32kHz \\ \hline
87 & SOSCO & RC14/T1CK & Cristal de cuarzo 32kHz \\ \hline
88 & U1BTX & RD1/SCK1ARS-232 & UART1B RS-232 TX \\ \hline
89 & U1ARX & RD2/SDI1ATULIO & UART1A RX \\ \hline
90 & U1ATX & RD3/SDO1ATULIO & UART1A TX \\ \hline
91 & RD4 &  & PULSADOR \\ \hline
92 & RD5 &  & PULSADOR \\ \hline
93 & RD6 &  &  \\ \hline
94 & RD7 &  &  \\ \hline
95 & VDDcore &  & VCC, con dos condensadores \\ \hline
96 & VDD &  & ALIMENTACIÓN \\ \hline
97 & RF0 &  &  \\ \hline
98 & RF1 &  &  \\ \hline
99 & RE0 &  & LED \\ \hline
100 & RE1 & WIFI & CS*\\ \hline
\\ % esta línea es importante para que deje un espacio entre la tabla y el nombre de la tabla.

\caption{PIC32675F256L pins use description.}
\label{tab:cap4:micropinout}

\end{longtable}}

%-------------------------------------------------------------------
\subsection{Radio Interfaces}
%-------------------------------------------------------------------
As it was mentioned, \ac{CNGD} will be able to include up to three \ac{RI}s, with three consequent frequency band to access. This fact gives a flexibility over radio communictions never offered by other \ac{WSN} device. Frequencies to operate over are 434 MHz, 868 MHz, and 2.4 GHz, meeting desired features. 

For communication on 434 MHz and 868 MHz, ad-hoc designed \ac{RI}s described in Section \ref{cap4:sec:transceivers} are used. These \ac{RI}s are based on the MRFX49XA radio transceiver and a full description of them can be found at such section. These \ac{RI}s share common features since the radio transceiver module is identical for both. This brings simplicity to the system. Interface between these \ac{RI}s and \ac{MCU} are the same. Figure \ref{fig:cap4:434schematics} shows the schematic for one of them.

Figure \ref{fig:cap4:2.4schematics} shows the scheme for the \ac{RI} at 2.4 GHz. This is based on a MRF24J40MA****REF. This \ac{RI} was already used at the \ac{FCD} and it is supported by the firmware. It is a MiWi$^{TM}$ transceiver also compatible with the IEEE 802.15.4 standard, this homogeneity with the other two \ac{RI}s supposses computation, cost, and power savings. It has access over the 15 5MHz-channels the protocol enables and employs a \ac{QPSK} modulation. Figure \ref{fig:cap4:mrf24j40mablocks} shows the MRF24J40MA block diagram. Further details about the MRF24J40MA \ac{RI} follow:

\begin{itemize}
	\item Operating Voltage: 2.4-3.6V (3.3V typical).
	\item Up to 120 meters range.
	\item Differential RF Input/Output:
	\begin{itemize}
		\item -94 dBm Typical sensitivity with +5 dBm maximum nnput level.
		\item +0 dBm Typical putput power.
	\end{itemize}
	\item Maximum supportted data rates:
	\begin{itemize}
		\item 250 kbps.
		\item Turbo mode enables up to 625 kbps (not following the standard).
	\end{itemize}
	\item Current Consumption:
	\begin{itemize}
		\item TX. I = 23 mA (typical).
		\item RX. 19 mA (typical).
		\item Sleep. 2$\mu$A (typical).
	\end{itemize}	
	\item Integrated crystal, internal voltage regulator, matching circuitry, \ac{PCB} antenna, and \ac{RSSI} detector. 
\end{itemize}


%SEÑALES DE COMMUNICATION

% ENTRAMOS A DETALLAR MIWI

\figura{Vectorial/Todo}{width=0.7\textwidth}{fig:cap4:mrf24j40mablocks}%
{MRF24J40MA block diagram}

\figura{Bitmap/Capitulo4/434}{width=0.7\textwidth}{fig:cap4:434schematics}%
{434/868 MHz Radio Interface systems schematic}

\figura{Vectorial/Todo}{width=0.7\textwidth}{fig:cap4:2.4schematics}%
{2.4 GHz Radio Interface systems schematic}

The MiWi P2P protocol stack supports star and peer-to-peer wireless-network topologies, useful for simple, short-range, wireless node-to-node communication. Additionally, the stack provides sleeping-node, active-scan and energy-detect features while supporting the low-power requirements of battery-operated devices.

\figura{Bitmap/Capitulo4/miwistack}{width=.4\textwidth}{fig:cap4:miwistack}%
{MiWi$^{TM}$ Protocol stack.}

%-------------------------------------------------------------------
\subsubsection{Software Controlled Power Supply}
%-------------------------------------------------------------------
The designed system allows enabling/disabling the power supply to the \ac{RI}s. This way, any \ac{RI} can be completely switched off by the running application. Cutting down all possible power consumption that unused \ac{RI}s could have by, for instance, running clocks.

The power control to the \ac{RI}s is based on the ADG701**** REF. This is a  \ac{CMOS} \ac{SPST} switch. This switch is designed to provide low power dissipation, low on resistance and low leakage currents. It can operate from a single 1.8 V to 5.5 V supply, making it ideal for use in battery-powered instruments.

Some of the features of this component are:
\begin{itemize}
	\item 2 ohm (typical) on resistance.
	\item Fast switching times: tON = 18 ns, tOFF 12 ns.
	\item Typical power consumption < 0.01 $\mu$W. 
\end{itemize}

\figura{Bitmap/Capitulo4/adg701}{width=.3\textwidth}{fig:cap4:adg701}%
{ADG701 pin diagram.}

Pin 4 (IN) is a digital input where the control logic signal is placed. A logic '1' will make pins 1 (D - drain) and  2 (S - source) shorted, a logic '0' will open the switch. Pins 1 and 2 can be either inputs or outputs. Pin 5 (NC) must not be connected.

% RESISTENCIA OPCIONAL PARA DESACTIVAR MODULO ************************************************************************************************

%-------------------------------------------------------------------
\subsection{Power Supply System}
%-------------------------------------------------------------------
Power supply module is in charge of providing proper voltage anc current to the \ac{CNGD}. Chosen output voltage is 3.3V, being this a normal value for \ac{CMOS} family chips. The power supply system must be able to support either wired-fixed or battery options. Figure \ref{fig:cap4:powersupplyschematic} shows a schematic of this module.

For external wired options, the input voltage is 5V. This value is widely used to supply digital circuits and it is easy to access to 5 V sources. Moreover, it couples with the \ac{USB} voltage rate, being possible to supply the \ac{CNGD} through a $\mu$USB terminal that this module includes. Apart from this \ac{USB} terminal, a standard screw terminal block accepts 5V to supply the device. This 5V are lowered to 3.3V by a synchronous buck regulator. This buck regulator can be deactivated for power saving when unused just changing a jumper location.

For battery options, the module includes a DC connector. This connector accepts from 3.3V up to 3.6V. Higher voltages could damage the components since this voltage is directly injected into the circuitry to achieve higher efficiency. An included switch lets choosing the supply mode, either wired or portable.

A green led indicates that power is applied into the circuit, on the other hand, a led red indicates if power is supplied into the block terminal or the $\mu$USB terminal. This way, is easily noticeable the presence of voltage and current on the \ac{CNGD} and their origin input.       

The employed synchronous buck regulator is a MCP1603*****REF chip. This is a high-efficiency, fully-integrated 500 mA synchronous buck regulator with a 2.7V to 5.5V input voltage range. The MCP1603 is available with either an adjustable or fixed output voltage. The are several available fixed output voltage options, the chosen option here is 3.3V. When a fixed option is used, only three additional small external
components are needed to form a complete solution, Figure \ref{fig:cap4:mcp1603}.

\figura{Vectorial/Todo}{width=0.4\textwidth}{fig:cap4:mcp1603}%
{MCP1603 buck regulator configuration}

It was estimated that 500 mA was enough to supply the device regarding the described maximum consumptions, Table \ref{tab:cap4:maxconsumption}.

\begin{table}[h]
\centering
\scalebox{0.7}{
\begin{tabular}{||c | c |||}
\hline \\
\hline \\
\hline \\
\hline \\

\end{tabular}
}
\caption{Maximum estimated power consumption of the platform.%
         \label{tab:cap4:maxconsumption}}
\end{table} 



%-------------------------------------------------------------------
\subsubsection{Battery}
%-------------------------------------------------------------------
In order to give autonomy and portability to the device, a rechargeable battery system will be included. This system must keep down the global cost and size. At the same time it must offer some days autonomy to the device. Voltage offered by the battery system must be on the 3.3-3.6V range. 

Firstly it is needed an estimation of platform global power consumption. This value will depends, relying strongly on the running application. However, we can assum some overstimated common values for our study. Considering two operation modes, Active and Sleep, and using values of current and operation times at Table \ref{tab:cap4:powerstimatedvalues}, it results in an approximated global power consumption calculated in \ref{}****.

\begin{table}[h]
\centering
\scalebox{0.7}{
\begin{tabular}{||c | c |||}
\hline \\
\hline \\
\hline
\end{tabular}
}
\caption{Estimated values for Active and Sleep operation modes.%
         \label{tab:cap4:powerstimatedvalues}}
\end{table} 

%Capacidad estimada......................................

Table \ref{tab:cap4:batcomparison} shows a comparison between considered battery possibilities. Other options, not described at the table, have been directly discarded for showing unsutiable features. An example are \ac{NICD} technology batteries, which may suffer ``memory effect''\footnote{It is an effect observed in some kind of rechargeable batteries that causes them to hold less charge.}, or specific high capacity kind of batteries\footnote{For instance, those used in photography.} whose price is extremely high. Possible options considered are some \ac{NIMH}-based battery sizes and lithium-based. 

\begin{table}[h]
\centering
\scalebox{0.7}{
\begin{tabular}{||c | c |||}
\hline \\
\hline \\
\hline
\end{tabular}
}
\caption{.%
         \label{tab:cap4:batcomparison}}
\end{table} 


Ni-Mh AAA
Ni-Mh AA
Ni-Mh specific battery
LI-ION
LI-PO

%SOLUCION
%-------------------------------------------------------------------
\subsection{Timing}
%-------------------------------------------------------------------
The microcontroller includes possibilities to properlly place quartz crystals in parallel with internal amplifiers and a pair of suitable capacitors in such way they work as oscillators. The oscillator signal is then connected to the internal \ac{PLL} to obtain the desired frequency. Schematic can be seen at Figure \ref{}**********.

Primary oscillator is 8 MHz quartz crystal used as system reference clock. The respective \ac{PLL} is configured to raise this frequency up to 80 MHz. It exists the possibility of replacing the functionality of this clock for a internal one, but stability and accuracy can be affected.

\figura{Vectorial/Todo}{width=.3\textwidth}{fig:cap4:prioscillators}%
{PIC32MX675F256L primary oscillator input.}

% CAPACITORS (CUADERNITO)

Second oscillator, a 32.728 KHz, supposes a low-power clock for real time clocking. It enables nodes synchronization, which is fundamental for power-saving modes.

\figura{Vectorial/Todo}{width=.3\textwidth}{fig:cap4:secoscillators}%
{PIC32MX675F256L second oscillator input.}

% CAPACITORS (CUAD)

%-------------------------------------------------------------------
\subsection{Expansion Headers}
%-------------------------------------------------------------------

Figure \ref{fig:cap4:headerschematic} shows the schematic design for this module. Basically, two headers, containing 20 pins each, enable access to unused and useful peripherals the microcontroller includes. This offer possibilities to future implementations and expansions for the node by simply attaching a device through these headers and carryng through the corresponding firmware adaptations.

Some of the available peripherals are ***************************. For a pin to pin description of the headers, reffer to Table \ref{tab:cap4:headerspinout}.

Possible attachable implementations are 802.11 interfaces, data adquisition modules, external memories, extra \ac{RI}s...

%-------------------------------------------------------------------
\subsubsection{Pinout}
%-------------------------------------------------------------------

\begin{center}
{\footnotesize
\begin{longtable}{l l l l l}

% aquí añadimos el encabezado de la primera hoja.
\hline
PIN & MICROCONTROLLER PIN & 1st TYPE & 2nd TYPE & 3rd TYPE \\
\hline \hline
\endfirsthead

% aquí añadimos el encabezado del resto de hojas.
\hline
PIN & MICROCONTROLLER PIN & 1st TYPE & 2nd TYPE & 3rd TYPE \\
\hline \hline
\endhead

% aquí añadimos el fondo de todas las hojas, excepto de la última.
\multicolumn{5}{c}{Follows on next page.}
\endfoot

% aquí añadimos el fondo de la última hoja.
\endlastfoot

% aquí añadimos el cuerpo de la tabla.
00 &  \\ \hline
01 &  \\ \hline
02 & \\ \hline
03 & & & \\ \hline
04 &  \\ \hline
05 &  \\ \hline
06 &  \\ \hline
07 & \\ \hline
08 &   \\ \hline
09 & \\ \hline
10 &  \\ \hline
11 &  \\ \hline
12 &  \\ \hline
13 &  \\ \hline
14 &  & VCC &  \\ \hline
15 &  & GND &  \\ \hline
16 &  \\ \hline
17 & \\ \hline
18 &  \\ \hline
19 &  \\ \hline
20 &  \\ \hline
21 &  \\ \hline
22 &  \\ \hline
23 &  \\ \hline
24 &  & VCC &\\ \hline
25 &  \\ \hline
26 &  \\ \hline
27 &  \\ \hline
28 &  & VCC &\\ \hline
29 &  \\ \hline
30 &  \\ \hline
31 &  & GND &\\ \hline
32 & \\ \hline
33 &   \\ \hline
34 &  & GND & \\ \hline
35 & \\ \hline
36 &   \\ \hline
37 &   \\ \hline
38 & \\ \hline
39 &  \\ \hline
 % esta línea es importante para que deje un espacio entre la tabla y el nombre de la tabla.
\caption{Headers description pins use description.}
\label{tab:cap4:headerspinout}
\end{longtable}}
\end{center}

%-------------------------------------------------------------------
\subsection{PGE}
%-------------------------------------------------------------------

Figure \ref{}******* contains the schematic for the programmer module, PGE. This module allows the programming and debugging tasks over the microcontroller making use of the tools provided my Microchip. For this, PGE microcontoller ports are interfaced through a RJ-12 connector together with power supply pins and reset signal.

\figura{Vectorial/Todo}{width=.3\textwidth}{fig:cap4:pge}%
{PGE interface.}


% ICD 3*************************************************************

%-------------------------------------------------------------------
\subsection{Other considerations}
%-------------------------------------------------------------------

GENERAL PURPOSE LEDS AND PULSADORES

%-------------------------------------------------------------------
\section{Serial Communication Board - rs232SHIELD}
%-------------------------------------------------------------------
\label{cap4:sec:rs232shield}
%-------------------------------------------------------------------

%-------------------------------------------------------------------
\subsection{Description}
%-------------------------------------------------------------------
This extension sets serial communication between the microcontroller and a pc over a RS-232 protocol. It supposses an alternative wired serial communication way for the included \ac{USB} option. This technology has been progresively replaced by the already said \ac{USB} for serial communication purposes, and it supposses an increase of the complexity, size, and consumption. That is why it was chosen not to embbed this module over the \ac{CNGD}, but rather create a expansion module. 

This technology could be useful for old machines, low-resources researches, or for debbuging purposes during the platform development until the \ac{USB} communication is fully operative. This communication way has a simpler operation mode than \ac{USB}.

Figure \ref{fig:cap4:rs232shieldschematic} shows the schematic for this shield. It is used one of the accessible \ac{UART} at the headers. Since RS-232 standard operates on voltage values from -12V to 12V, a level conversion is needed. This conversion takes place at the MAX3232********REF transceiver. Figure \ref{fig:cap4:max3232} shows the MAX3232 scheme. \ac{TX} pin of the \ac{UART} is accessed at pin *************, \ac{RX} is at *************. Since this \ac{UART} does not support hardware flow control\footnote{Hardware flow control allows to control the serial data flow by using extra signals appart from the data signals.}, two pins are enough to set proper communication.

%-------------------------------------------------------------------
\subsection{Schematics}
%-------------------------------------------------------------------

\figura{Vectorial/Todo}{width=.4\textwidth}{fig:cap4:rs232shieldschematic}%
{rs232SHIELD schematic.}


%-------------------------------------------------------------------
\section{Batteries charger - chargerSHIELD}
%-------------------------------------------------------------------
\label{cap4:sec:chargerShield}
%-------------------------------------------------------------------

%-------------------------------------------------------------------
\subsection{Description}
%-------------------------------------------------------------------
%-------------------------------------------------------------------
\subsection{Schematics}
%-------------------------------------------------------------------

\figura{Vectorial/Todo}{width=.4\textwidth}{fig:cap4:chargershematic}%
{chargerSHIELD schematic.}

%-------------------------------------------------------------------
\subsection{Simulation}
%-------------------------------------------------------------------

% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
