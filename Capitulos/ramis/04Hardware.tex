%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Hardware}

\begin{FraseCelebre}
\begin{Frase}
This new form of communication\\could have some utility.
\end{Frase}
\begin{Fuente}
Guglielmo Marconi
\end{Fuente}
\end{FraseCelebre}

\begin{resumen}
El capítulo comienza con un análisis de mercado de equipos de \mbox{comunicación} que operan en la banda 868 MHz seleccionando, finalmente, los módulos XBee-PRO 868 de Digi International para la implementación del prototipo de red. A continuación, éstos se describen en profundidad y, tras ser adquiridos, se configuran y prueban utilizando el software gratuito X-CTU del mismo fabricante. Por último, se realiza un estudio teórico de un enlace radioeléctrico en el mar, y los resultados se comparan y relacionan con medidas reales efectuadas con los módulos seleccionados en dicho entorno.
\end{resumen}


%-------------------------------------------------------------------
\section{Análisis de mercado y elección del equipo}
%-------------------------------------------------------------------
\label{cap4:sec:mercadoEquipo}
Una vez decidida la banda de operación, se realizó un estudio de mercado orientado a la elección de los equipos. Aunque una gran parte de los módulos de comunicación que operan en la banda ICM de 868 MHz tienen una potencia máxima de salida de 10 dBm (10 mW), existen algunos que operan por encima de ésta permitiendo, junto con la correspondiente antena, alcanzar el límite de PIRE de 29.15 dBm (822 mW) impuesto en la banda. En la Tabla~\ref{cap4:tab:eleccionEquipo} se muestran las características técnicas de cinco módulos de comunicación destacados del estudio de mercado.

\begin{table}[t]
\footnotesize
\centering
\scalebox{0.8}{
\begin{tabular}{| c | c | c c c c c |}
\hline
\hline
\textbf{Equipos}	& Fabricante	& ADEUNIS	& SYNAPSE	& DIGI INT.		& QUASAR	& TELIT			\\
 			& Modelo	& TWINO HP868	& RF301PC1/U1	& XBee-PRO$^{\textregistered}$868& HM-TRP868D	& TinyOnePro868MHz 	\\
\hline
& & & & & & \\ 
\textbf{Rendimiento}	& Potencia de 	& 27 dBm	& 13 dBm	& 25 dBm		& 20 dBm	& 27 dBm		\\
		  	& transmisión   &		& 		&			& 		& @ 3.6 V		\\
& & & & & & \\ 
			& Sensibilidad	& -110 dBm	& -121 dBm	& -112 dBm		& -117 dBm	& -105 dBm		\\
			&		&		& @ 9.6 kbps	& (1\% PER)		& @ 1.2 kbps	& 4.8 kbps		\\
			&		&		&(10\% BER)	& 			&		& (CER $10^{-3}$)	\\
& & & & & & \\
			& Link Budget	& 137 dB	& 134 dB	& 137 dB		& 137 dB	&  132 dB		\\
& & & & & & \\
			& Alcance	& 6 km	 	& 500m / 1.6km	& 40 km			& 1 km	 	& 4 km			\\
& & & & & & \\
			& Tasa 		& 10/38.4/	& 150 kbps	& 24 kbps		& 1.2 -		& 38.4 kbps		\\
			& transmisión	& 57.6 kbps	&		& 			& 115.2 kbps	& 			\\
\hline
& & & & & & \\
\textbf{Interfaz serie}	& Tipo		& UART (x3)	& UART 		& UART			& UART		& RS232			\\
			&		& $I^{2}C$ (x2) & 		&			& RS232		& 			\\
			&		& SPI (x2)	&		& 			&		& 			\\
& & & & & & \\
			& Velocidad	& -		& -		& 1.2 -			& 1.2 -		& 1.2 -			\\
			& 		& 	 	&  		& 230.4 kbps		& 115.2 kbps	& 115.2 kbps		\\
\hline
& & & & & & \\
\textbf{Requisitos}	& Voltaje	& 3 - 3.6	& 2.7 -3.6	& 3.0 - 3.6		& 2.4 - 3.6	& 3.0 - 3.6 		\\
\textbf{de energía}	& (VDC)		&		& 		&			& 		& 			\\
& & & & & & \\
			& $I_{TX}$ 	& 600 mA	& 30 mA		& 500 mA		& 120 mA	& 600 mA		\\
& & & & & & \\
			& $I_{RX}$ 	& 18 mA		& 18 mA		& 65 mA			& 30 mA		& 30 mA			\\
& & & & & & \\
			& $I_{Sleep}$	& $20\mu A$	& $2\mu A$ 	& $55\mu A$		& $2\mu A$ 	& $<5\mu A$	 	\\
\hline
& & & & & & \\
\textbf{Creación}	& Topología	& P2P, P2MP 	& P2P, P2MP	& P2P, P2MP		& P2P, P2MP	& P2P, P2MP		\\ 
\textbf{de redes}	& soportada	& 		& y malla	& 			& 		& y malla		\\
& & & & & & \\
			& Firmware	& -		& SNAP		& - 			& -		& M-ONE			\\
			& propietario	&		&		&			& 		& 			\\
\hline
& & & & & & \\
\textbf{Otros}		& Conector de	& I/O 50$\Omega$& Antena chip /	& Wired whip,		& I/O 50$\Omega$& I/O 50$\Omega$	\\
			& antena	&		& conector U-FL	& U-FL y RPSMA		& 		& 			\\
& & & & & & \\
			& Modulación	& GFSK		& GFSK		& -			& FSK		& GFSK			\\
& & & & & & \\
			& Disponibilidad& SI		& SI / Q3 2011	& SI			& SI		& SI			\\
& & & & & & \\
			& Precio	& 80		& -		& 57			& 25		& 90			\\
&\euro & & & & & \\
\hline
\hline
\end{tabular}}
\caption{\small{Características técnicas de módulos de comunicación de alta potencia en la banda 868MHz.}%
         \label{cap4:tab:eleccionEquipo}}
\end{table}

A la hora de decantarse por uno u otro equipo, al tratarse este proyecto de la realización de un prototipo que sirva de primera aproximación a la herramienta y permita evaluar su viabilidad, se consideran factores importantes para la selección:
\begin{itemize}
\item El precio, ya que no debe suponer una gran inversión.
\item El tiempo de desarrollo hardware y software que implicará el poder comenzar a utilizar el equipo. Por ello, se valora positivamente los módulos cuyo firmware ya permite la operación en malla, soportando el multisalto en la red, y aquellos que requieran un menor montaje previo a su empleo.
\end{itemize}  

El módulo RF301PC1/U1 de Synapse utiliza el firmware SNAP, que soporta la topología de malla. Actualmente éste sólo está disponible con antena chip, lo que limita mucho sus posibilidades de alcance. El lanzamiento al mercado del modelo con conector U-FL está previsto para el tercer cuatrimestre del 2011, por lo que este módulo se descarta para el proyecto aunque, en un futuro, con los nuevos modelos, podría ser una buena solución. 

El otro módulo que soporta topología de malla, gracias a su firmware M-ONE, es el TinyOne Pro 868MHz de Telit. Este equipo está disponible en dos versiones. La primera opción es un terminal directamente preparado para su conexión y utilización. Éste, supondría una gran solución tanto técnica como en términos de tiempo, ya que únicamente requeriría una configuración previa. El inconveniente por el que se descarta el terminal es su elevado precio, 322\euro, que elevaría el coste final de la herramienta de mitigación y por lo tanto afectaría a su viabilidad y aceptación en la industria.

La segunda opción es su versión en módulo, que requiere la incorporación de un conector de antena y de un interfaz para su conexión con el ordenador. Otra limitación que presenta este equipo, en comparación con otros de la tabla, es que su potencia de transmisión es de \mbox{27 dBm} por lo que, únicamente, se podría aumentar en 2 dB con una antena para no exceder la limitación de la banda. Otros equipos tienen un margen mayor hasta la PIRE máxima, lo que permitirá lograr un link budget varios decibelios mayor que en este caso. Finalmente, su precio es de 90\euro, superior al de otros módulos. Por todo ello, también se descarta la utilización del TinyOne PRO 868 MHz de Telit, tanto en su versión terminal como en módulo.

Los tres módulos restantes implicarán la utilización de un protocolo de enrutamiento ad hoc que irá implementado en el PC embebido. Este tema se tratará en detalle en el \mbox{Capítulo 5}, junto con el resto de la parte software.

El Twino HP868 de Adeunis, y el HM-TRP868D de Quasar, tienen el mismo inconveniente que la versión módulo del TinyOne Pro 868 MHZ. Ambos requieren la implementación de un interfaz para su conexión con el ordenador y, también, la incorporación de un conector para la antena. Además, el modelo de Adeunis tiene un precio elevado en comparación con los otros y la misma limitación para aumentar su link budget debido a la PIRE máxima de la banda. Por ello, el Twino HP868 también se descarta.
 
Entre los restantes está el XBee-PRO 868 de Digi International y el HM-TRP868D de Quasar. Se opta por el primero, a pesar de ser de entre los dos el más caro. Los motivos son:
\begin{itemize}
\item Se trata de un módulo \textit{out of the box}; es decir, únicamente requiere su conexión mediante un adaptador UART-USB al ordenador, acoplarle la antena y configurarle.
\item El fabricante dispone de un software gratuito llamado X-CTU para facilitar su configuración en modo gráfico, en vez de por comandos. Este software, además, dispone de una herramienta para realizar pruebas de alcance entre dos de estos módulos.
\item Su firmware permite una gran variedad de opciones, como: asignar direcciones a los módulos, utilizar repeticiones de envío a nivel MAC, enviar acuses de recibo, emplear encriptación de los datos, etc.
\item Se trata de un módulo muy popular, existen numerosos proyectos documentados realizados con él y diferentes adaptadores UART-USB disponibles en el mercado compatibles con su patillaje.
\item Hay una versión idéntica que opera en 900 MHz, lo que permitiría migrar facilmente de una a otra banda según la región en la que se utilice.
\item Se tiene constancia de su utilización en el medio marino entre boyas, logrando hasta 3 kilómetros de alcance \citep{sieber1} \citep{sieber2}. Éste es un hecho importante ya que, como se puede observar en la tabla, a pesar de que todos los módulos tienen un link budget similar y utilizan modulación en frecuencia, los alcances indicados en las hojas técnicas de los fabricantes varían entre 1 kilómetro y 40. Por ello, conocer casos reales de su utilización permite tener una idea más fiable de sus prestaciones.
\end{itemize}


%-------------------------------------------------------------------
\section{XBee-PRO$^{\textregistered}$868 RF Modules}
%-------------------------------------------------------------------
\label{cap4:sec:xbeepro}
%-------------------------------------------------------------------
\subsection{Descripción}
%-------------------------------------------------------------------
\label{cap4:sec:descripcion}
%-------------------------------------------------------------------
Los módulos XBee-PRO 868, como se mostró en la sección anterior, poseen una potencia de transmisión y una sensibilidad elevadas, lo que les hace ideales para su utilización en largas distancas. Además, su reducido tamaño, 2.443 x 3.322 cm, y su bajo consumo le convierten en una solución apropiada para su utilización en sistemas aislados.

El módulo cuenta con dos buffers internos independientes, que son:
\begin{itemize}
\item Buffer de entrada serie. Almacena la información que llega por el pin de entrada de datos, llamado DIN, hasta que ésta pueda ser procesada.
\item Buffer de salida serie. Guarda la información RF recibida y la envía por el pin de salida de datos o DOUT, cuando éste está libre para usarse.
\end{itemize} 
Gracias a estos dos buffer el equipo puede actuar como transceptor, recibiendo y enviando datos sin que estos se pierdan.

Los módulos XBee-PRO 868 disponen de dos modos de operación:
\begin{itemize}
\item \textbf{Transparente}. En este modo se comportan como una línea serie, de modo que, todos los datos UART recibidos por el pin DIN se encolan para su transmisión. Por otra parte, la información RF recibida se envía hacia el ordenador a través del pin DOUT. Los módulos cuentan con una función de paquetización que se encarga de enpaquetar la información del buffer de entrada serie. Estos paquetes, que tendrán un tamaño máximo de 256 bytes, se envían cuando:
\begin{itemize}
\item No se reciben más caracteres por el pin DIN durante un timeout determinado por el usuario en la configuración.
\item Se alcanza el tamaño máximo de paquete.
\end{itemize}
\item \textbf{\ac{API}}. Este modo está basado en la \mbox{utilización} de tramas ya definidas. La información debe llegar al módulo mediante comandos y éste se encargará de crear las tramas. Por ello, resulta algo más complejo de utilizar que el transparente. Este modo permite una utilización más completa de las funciones definidas en el firmware del módulo, y facilita algunas operaciones como:
\begin{itemize}
\item Envío de datos a múltiples destinatarios.
\item Control de paquetes recibidos correcta o incorrectamente.
\item Identificación del remitente de cada paquete.
\end{itemize} 
\end{itemize}

Debido a que el firmware del módulo no soporta la formación de redes multisalto, éstos se utilizarán en modo transparente y enviarán todos sus mensajes en difusión o \mbox{broadcast}. Como ya se comentó anteriormente, la capa de red o el protocolo de encaminamiento se implementará en el PC embebido, por lo que los mensajes llegarán al XBee con sus correspondientes cabeceras y listos para ser enviados.

En la Figura~\ref{fig:cap4:xbee}, se puede observar una vista superior y otra inferior del módulo. En la segunda, una pegatina indica cierta información relevante como: el part number o referencia del fabricante, la revisión del firmware, el número de serie y la fecha y hora en la que se fijó esa información. En concreto, los módulos adquiridos tienen la última revisión del firmware, designada con la letra G. Ésta se realizó el 22 de Febrero de 2011.

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:frontalXbee}%
Vista superior.}%
\includegraphics[width=0.215\textwidth]%
{Imagenes/Bitmap/Capitulo4/frontalXbee}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:dorsoXbee}%
Vista inferior.}%
\includegraphics[width=0.355\textwidth]%
{Imagenes/Bitmap/Capitulo4/dorsoXbee}%
\end{SubFloat}
\caption{Vistas del módulo XBee-PRO 868.}
\label{fig:cap4:xbee}
\end{figure}

Para la conexión del XBee-PRO 868 al ordenador se ha optado por utilizar un conversor UART-USB (ver Figura~\ref{fig:cap4:explorer}). Éste está especialmente diseñado para operar con todas las unidades XBee de Digi International. Concretamente, utiliza el integrado FT232RL, conocido como solución para reemplazar el puerto RS232 por el USB en nuevos diseños. Viene con drivers libres de royalties para la mayoría de los sistemas operativos, entre ellos Windows y GNU/Linux. Además, desde Agosto de 2010, estos conversores incluyen el regulador de potencia MIC5219, que convierte los 5V del USB en 3.3V para la alimentación del XBee, y soporta corrientes de hasta 500 mA, necesarias en los modelos PRO.

También se han adquirido antenas de 4.5 dBi de ganancia con conector RPSMA, compatible con el XBee-PRO 868. De esta manera, se alcanza una PIRE de 29.5 dBm, ajustada al límite permitido en la banda. En la Figura~\ref{fig:cap4:nodo} se puede observar un nodo formado por el módulo de comunicación, la antena y el conversor UART-USB.

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:explorer}%
Conversor UART-USB.}%
\includegraphics[width=0.35\textwidth]%
{Imagenes/Bitmap/Capitulo4/explorer2}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:nodo}%
Aspecto final del módulo de comunicación.}%
\includegraphics[width=0.44\textwidth]%
{Imagenes/Bitmap/Capitulo4/nodo}%
\end{SubFloat}
\caption{Conversor UART-USB y nodo final formado por el XBee-PRO 868, la antenna y el conversor UART-USB.}
\label{fig:cap4:equipoComunicacion}
\end{figure}

En el Apéndice~\ref{ap1:presupuesto} se incluye el presupuesto del proyecto, donde puede observarse un desglose detallado del equipo adquirido y los proveedores.

Toda la documentación de estos módulos se encuentra disponible gratuitamente en la \mbox{página} Web de Digi International\footnote{http://www.digi.com/}. En ella, se encontrarán las tablas de referencia de \mbox{comandos}, necesarias para la configuración de los módulos. En las próximas secciones se hará referencia a algunos parámetros de configuración, explicándolos brevemente. Para obtener una descripción más detallada de los mismos se remite al lector a la documentación indicada.


%-------------------------------------------------------------------
\subsection{Software X-CTU}
%-------------------------------------------------------------------
\label{cap4:sec:xctu}
X-CTU es una aplicación gráfica desarrollada y distribuida gratuitamente por Digi International. Este software permite interactuar, de una manera fácil e intuitiva, con el firmware utilizado en los módulos RF de dicha compañía. Concretamente, al ejecutar esta aplicación se muestra una ventana con cuatro pestañas que son:
\begin{itemize}
\item \textbf{PC Settings}. Permite al usuario seleccionar el puerto COM deseado y configurar este adecuadamente para comunicarse con el módulo radio. 

En GNU/Linux es necesario realizar una operación previa para que el programa reconozca correctamente el puerto deseado. Tras ejecutar X-CTU con \textit{Wine} el programa se instala en el directorio \texttt{\textasciitilde{}/.wine/drivec/Archivos de programa/Digi/XCTU}. Al conectar el conversor UART-USB el sistema lo reconoce como \texttt{/dev/ttyUSB0}. Para que \mbox{X-CTU} pueda ver dicho puerto es necesario crear un enlace suave en la carpeta \texttt{dosdevices} de Wine. El comando para ello es: \texttt{ln -s /dev/ttyUSB0 \textasciitilde{}/.wine/dosdevice/com5}. Una vez realizado esto, únicamente hay que ejecutar X-CTU, en la pestaña de \textit{PC Settings} pinchar en \textit{User Com Ports}, escribir el puerto creado en la casilla \textit{Com Port Number} y, finalmente, \textit{Add}. (ver Figura~\ref{fig:cap4:PCsettings}).
\end{itemize}

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:PCsettings}%
Pestaña PC Settings.}%
\includegraphics[width=0.42\textwidth]%
{Imagenes/Bitmap/Capitulo4/PCsettings}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:rangeTest}%
Pestaña Range Test.}%
\includegraphics[width=0.42\textwidth]%
{Imagenes/Bitmap/Capitulo4/rangeTest}%
\end{SubFloat}
\begin{SubFloat}
{\label{fig:cap4:terminal}%
Pestaña Terminal.}%
\includegraphics[width=0.42\textwidth]%
{Imagenes/Bitmap/Capitulo4/terminal}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:modemConf}%
Pestaña Modem Configuration.}%
\includegraphics[width=0.42\textwidth]%
{Imagenes/Bitmap/Capitulo4/modemConf}%
\end{SubFloat}
\caption{Pestañas del software X-CTU de Digi International.}
\label{fig:cap4:pestañasXCTU}
\end{figure}

\begin{itemize}
\item \textbf{Range Test}. Permite al usuario realizar pruebas de alcance entre dos módulos. Como se observa en la Figura~\ref{fig:cap4:rangeTest}, dispone de las siguientes opciones:
\begin{itemize}
\item Modificar el tamaño de los paquetes de datos para las pruebas.
\item Seleccionar los valores mínimo y máximo permitido de retardo de paquetes.
\item Fijar un número concreto de paquetes a enviar en la prueba. También permite la opción de detener el proceso en caso de que alguno se pierda.
\item Elegir el timeout de espera de datos. Una vez superado este valor, se da el paquete por perdido.
\item Medir el RSSI de cada paquete recibido.
\item Calcular el \ac{PER} del total de paquetes enviados en la prueba.
\end{itemize}

\item \textbf{Terminal}. Permite acceder al puerto COM mediante una emulación de terminal. Así se puede acceder al firmware mediante la utilización de comandos AT (ver Figura~\ref{fig:cap4:terminal}).

\item \textbf{Modem Configuration}. Posibilita la configuración del módulo a través de un interfaz gráfico. Además, desde esta pestaña es posible cambiar entre las diferentes versiones del firmware (ver Figura~\ref{fig:cap4:modemConf}).

\end{itemize}


%-------------------------------------------------------------------
\subsection{Primeras pruebas}
%-------------------------------------------------------------------
\label{cap4:sec:primerasPruebas}
%-------------------------------------------------------------------
Para verificar el correcto funcionamiento de los módulos XBee-PRO 868 adquiridos, se realizaron pruebas de transmisión y recepción con todos ellos. Los parámetros de configuración se mantuvieron prácticamente todos como venían por defecto, únicamente se modificaron los siguientes:
\begin{itemize}
\item \textbf{RR - MAC Retries}. Se le dió el valor 0. De esta manera cada paquete unicast sólo se envía una única vez, aunque no se reciba su correspondiente acuse de recibo (ACK).
\item \textbf{MT - Multiple Transmissions}. Se le dió el valor 0. De esta manera cada paquete broadcast sólo se envía una única vez.
\item \textbf{PL - TX Power Level}. Se realizaron pruebas tanto con el valor 0, equivalente a 0 dBm, como con el valor 4, equivalente a la máxima potencia, 25 dBm.
\end{itemize}

Para la realización de las pruebas con la aplicación \textit{Range Test} se debe proceder de la siguiente manera. Un módulo debe configurarse en \textit{loopback} o bucle, es decir, se conecta el pin DIN con el DOUT, de modo que dicho módulo retransmite lo que recibe. En la Figura~\ref{fig:cap4:jumper} se puede observar como se implementó dicho \textit{loopback} en un módulo utilizando un \textit{jumper}.

\figura{Bitmap/Capitulo4/jumper}{width=.25\textwidth}{fig:cap4:jumper}%
{Módulo configurable en \textit{loopback} mediante un \textit{jumper}.}

De este modo, se verificó que los tres módulo adquiridos eran capaces de transmitir y recibir información correctamente entre ellos. Únicamente se destacan dos observaciones que se hicieron:
\begin{itemize}
\item Como muestra la Figura~\ref{fig:cap4:maxRSSI}, el valor máximo de RSSI medido es -62 dBm. Se averiguó, consultando en el foro oficial de Digi International, que estos módulos tienen la limitación de que únicamente muestran los valores de RSSI próximos al nivel de sensibilidad del mismo. Por ello, cuando los módulos se encuentren próximos el máximo valor de RSSI que se registrará será siempre -62 dBm.
\item Como se observa en la Figura~\ref{fig:cap4:minRSSI}, el valor mínimo de RSSI medido es -104 dBm. Se realizaron varias pruebas, con distintas potencias de transmisión, en las que se buscaba el límite de distancia en el que empezaban a llegar los paquetes con errores, o directamente ni se recibían. En ningún caso se pudo registrar un valor de RSSI inferior a -104 dBm. Este hecho es importante, ya que entre la especificación del fabricante y los valores medidos existe una diferencia de 8 dB, un valor bastante considerable. Sobre esta situación no se encontró nada en Internet. Puesto que no se recibe ningún paquete con una potencia inferior a -104 dBm, para el estudio teórico se tomará este valor como sensibilidad del módulo. 
\end{itemize}

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:maxRSSI}%
Valor máximo de RSSI medido.}%
\includegraphics[width=0.4\textwidth]%
{Imagenes/Bitmap/Capitulo4/maxRSSI}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:minRSSI}%
Valor mínimo de RSSI medido.}%
\includegraphics[width=0.4\textwidth]%
{Imagenes/Bitmap/Capitulo4/minRSSI}%
\end{SubFloat}
\caption{Valores de mínimo y máximo de RSSI medidos con la aplicación \textit{Range Test}.}
\label{fig:cap4:RSSImedidos}
\end{figure}

%-------------------------------------------------------------------
\section{Estudio teórico de un enlace radioeléctrico en el mar}
%-------------------------------------------------------------------
\label{cap4:sec:calculoTeorico}
%-------------------------------------------------------------------
%-------------------------------------------------------------------
\subsection{Constitución del modelo}
%-------------------------------------------------------------------
\label{cap4:sec:constituciónModelo}
%-------------------------------------------------------------------
Antes de efectuar balances de pérdidas y ganancias de potencia, y cálculos de niveles de señal en diferentes interfaces de un sistema, se propone seguidamente un modelo general simplificado de sistema de radiocomunicación, al que se referirán los diferentes conceptos relativos a potencias, ganancias y pérdidas. El modelo se representa en la Figura~\ref{fig:cap4:modeloEnlace} y consta de los siguientes elementos e interfaces:

\begin{enumerate}
\item TX: Transmisor. Se conecta a la antena a través del interfaz AT, donde se descartan pérdidas por simplificar el modelo, y se centra la atención en cómo afecta el medio al radioenlace.
\item Antena de transmisión ideal. Termina en el interfaz virtual de antena isotrópica IT, por donde se accede al medio de propagación.
\item Antena de recepción ideal, a través de cuya interfaz virtual de antena isótropa de recepción IR, entra la señal al sistema receptor.
\item RX: Receptor. Se acopla a la antena a través del interfaz AR donde, por los mismos motivos explicados anteriormente, se descartan pérdidas.
\end{enumerate}

\figura{Vectorial/Capitulo4/modeloEnlace}{angle=270,width=.47\textwidth}{fig:cap4:modeloEnlace}%
{Modelo general simplificado de un sistema de radiocomunicación.}

Para la formulación de las ecuaciones de balance y diagramas de niveles se aprovechará la ventaja de la representación logarítmica de las señales y de las pérdidas, por lo que todas estas magnitudes se expresarán en dB y sus derivados. En el modelo se definen las siguientes potencias: 

\begin{itemize}
\item $P_{t}(dBm)$: potencia entregada por el transmisor a la antena. 
\item $PIRE(dBm)$: potencia isotrópica radiada equivalente en dirección hacia el receptor.
\item $P_{r}(dBm)$: potencia disponible a la entrada del receptor.
\end{itemize}

Únicamente se define la pérdida básica de propagación entre antenas isótropas, $L_{b}$. Se mide en $dB$ y es función de: la frecuencia, la distancia, las alturas de las antenas, el modo y medio de propagación, etc.

Las ganancia que aparecen en el modelo son las correspondientes a las antenas:
\begin{itemize}
\item $G_{t}(dBi)$: ganancia de potencia de la antena del transmisor.
\item $G_{r}(dBi)$: ganancia de potencia de la antena del receptor.
\end{itemize}

Para este estudio, de acuerdo con el equipo presentado en la Subsección~\ref{cap4:sec:descripcion}, se utilizan los siguientes valores:
\begin{itemize}
\item $P_{t}=25dBm$
\item $G_{t}=4.5dBi$
\item $PIRE=P_{t}+G_{t}=29.5dBm$
\item $G_{r}=4.5dBi$
\end{itemize}


%-------------------------------------------------------------------
\subsection{Balance de un enlace radioeléctrico}
%-------------------------------------------------------------------
\label{cap4:sec:balanceEnlace}
%-------------------------------------------------------------------
El balance del enlace es la relación que expresa la potencia disponible en el receptor en función de la potencia entregada por el transmisor y las diferentes pérdidas y ganancias que aparecen en el trayecto del transmisor al receptor. La ecuación general de balance del enlace es:

\begin{equation}
P_{r} = P_{t} + G_{t} - L_{b} + G_{r} 	\label{cap4:eq:balanceEnlace}
\end{equation}
donde las pérdidas y las ganancias están en dB, y las potencias en unidades logarítmicas similares, que en este caso serán dBm.

Si esta potencia disponible en el receptor es superior a su sensibilidad, se considerará que existe comunicación entre el transmisor y el receptor. Se recuerda que en la \mbox{Subsección~\ref{cap4:sec:primerasPruebas}} se registró de manera empírica que el módulo XBee-PRO 868 tiene una sensibilidad de \mbox{-104 dBm}. Este valor será el que se empleará para determinar el alcance teórico del enlace.


%-------------------------------------------------------------------
\subsection{Enlace radioeléctrico en condiciones de espacio libre}
%-------------------------------------------------------------------
\label{cap4:sec:espacioLibre}
%-------------------------------------------------------------------
En un sistema de radiocomunicaciones siempre interviene de alguna forma el medio de propagación. Sin embargo, se estudia el caso ideal de propagación en espacio libre como marco de referencia y para la determinación de la pérdida de propagación mínima que cabe esperar en el enlace.

Como se expuso en la Subsección~\ref{cap2:sec:fundamentosPropagacion}, la pérdida básica de propagación en condiciones de espacio libre, expresada en dB, es:
\begin{equation}
L_{bf}[dB] = 32.45+20\cdot log(d[km])+20\cdot log(f[MHz])	\label{perdidasEspacioLibre}
\end{equation}
donde $d[km]$ es la distancia en kilómetros entre el transmisor y el receptor, $f[MHz]$ es la frecuencia de operación en megahercios.

En la Figura~\ref{fig:cap4:freeSpacePathLoss} se representa la pérdida básica de propagación en condiciones de espacio libre en función de la distancia entre el transmisor y el receptor, utilizando como frecuencia de trabajo $f=869.525MHz$, que es la frecuencia central de la banda de operación.

\figura{Bitmap/Capitulo4/freeSpacePathLoss}{width=.82\textwidth}{fig:cap4:freeSpacePathLoss}%
{Pérdida básica de propagación en condiciones de espacio libre en función de la distancia, para una frecuencia de operación $f=869.525MHz$.}

Si evaluamos la ecuación general de balance del enlace, expresión~\ref{cap4:eq:balanceEnlace}, para una potencia entregada por el transmisor de 25 dBm, unas ganancias de transmisión y recepción de 4.5 dBi, la pérdida básica de propagación en el espacio libre para $f=869.525MHz$ y una sensibilidad del receptor de -104 dBm, la comunicación sería posible hasta una distancia de 218 kilómetros, como se muestra en la Figura~\ref{fig:cap4:pr_freeSpace}.

\figura{Bitmap/Capitulo4/pr_freeSpace}{width=.82\textwidth}{fig:cap4:pr_freeSpace}%
{Potencia disponible a la entrada del receptor en función de la distancia en \mbox{condiciones} de espacio libre, para una frecuencia de operación $f=869.525MHz$.}

Como se indicó al principio, este resultado se corresponde con el caso ideal, sin tener en cuenta de ninguna forma el medio de propagación. Por ello, en una implementación real no se espera lograr estos alcances. A continuación, se presenta otro modelo para predecir de una forma más realista las pérdidas básicas de propagación de una onda que viaja del transmisor al receptor sobre la superficie del mar.


%-------------------------------------------------------------------
\subsection{Influencia de la superficie sobre la que discurre la onda}
%-------------------------------------------------------------------
\label{cap4:sec:influenciaSuperficie}
%-------------------------------------------------------------------
Cuando el transmisor y el receptor se encuentran situados sobre la superficie terrestre, y entre ambos existe una visibilidad directa, se modela la propagación mediante un rayo directo y uno reflejado en la superficie. Además, dependiendo de algunos factores como: la naturaleza del terreno, la frecuencia y la polarización de la onda, puede existir también una componente de onda de superficie.

La expresión general del campo recibido, en estas condiciones viene dada mediante la llamada \textit{ecuación general de la propagación}:
\begin{equation}
e = e_{0}[1+R\cdot e^{-j\Delta} + (1-R) \cdot A \cdot e^{-j\Delta}]	\label{ecGpropagacion}
\end{equation}
donde:
\begin{itemize}
\item $e$: intensidad de campo en recepción en las condiciones reales.
\item $e_{0}$: intensidad de campo en condiciones de espacio libre.
\item $\Delta$: ángulo de desfasamiento entre la componente directa y la reflejada.
\item $R$: coeficiente de reflexión de la superficie.
\item $A$: término de atenuación de la onda de superficie.
\end{itemize}

En esta expresión, el primer término del paréntesis equivale a la componente de onda directa, el segundo a la de onda reflejada en el suelo, y el tercero a la onda de superficie.
El ángulo $\Delta$ es: 
\begin{equation}
\Delta = \frac{2\pi \Delta l}{\lambda}		\label{anguloDelta}
\end{equation}
donde $\Delta l$ es la diferencia entre el recorrido del rayo reflejado y el del rayo directo, y $\lambda$ es la longitud de onda.

El coeficiente de reflexión complejo $R$, se especifica en función de su módulo y fase:
\begin{equation}
R = |R|e^{-j\beta}		\label{coefRefComp}
\end{equation}

Tanto $|R|$ como $\beta$ son función de la frecuencia, polarización, características eléctricas del suelo y ángulo de incidencia $\Psi$.

Para el estudio de la propagación radioeléctrica, se caracteriza el terreno por los parámetros eléctricos: constante dieléctrica relativa, $\varepsilon_{r}$, y conductividad, $\sigma$(mhos/m). En la Recomendación UIT-R P.527, se facilitan datos sobre estos parámetros. Concretamente, para el agua salada (salinidad media), a una temperatura de 20ºC, y a una frecuencia de \mbox{869.525 MHz}, los valores son: $\varepsilon_{r}=70$ y $\sigma=5$ S/m.

Se define la permitividad compleja del suelo como:
\begin{equation}
\varepsilon_{0} = \varepsilon_{r} -j60\sigma \lambda		\label{permitividadComp}
\end{equation}

A partir de este parámetro, se define el parámetro $z$ en función de la polarización de la onda, y del ángulo de incidencia $\Psi$, del modo siguiente:

\textit{Polarización vertical}:
\begin{equation}
z = \frac{\left[ \varepsilon_{0} - \cos^{2}\Psi\right]^{1/2}} {\varepsilon_{0}}		\label{zVertical}
\end{equation}

\textit{Polarización horizontal}:
\begin{equation}
z = \left[\varepsilon_{0} - \cos^{2}\Psi\right]^{1/2}				\label{zHorizontal}
\end{equation}

El coeficiente de reflexión $R$ en una superficie plana viene dado por:
\begin{equation}
R = \frac{\sin\Psi - z}{\sin\Psi + z}				\label{RsupPlana}
\end{equation}

\newpage

Por lo que resulta:

\textit{Polarización vertical}:
\begin{equation}
R_{V} = \frac{\varepsilon_{0}\sin\Psi - \sqrt{\varepsilon_{0}-\cos^{2}\Psi}}
	{\varepsilon_{0}\sin\Psi + \sqrt{\varepsilon_{0}-\cos^{2}\Psi}}		\label{Rvertical}
\end{equation}

\textit{Polarización horizontal}:
\begin{equation}
R_{H} = \frac{\sin\Psi - \sqrt{\varepsilon_{0}-\cos^{2}\Psi}}
	{\sin\Psi + \sqrt{\varepsilon_{0}-\cos^{2}\Psi}} 				\label{Rhorizontal}
\end{equation}

Para este estudio, la antena dipolo $\lambda/2$ es perpendicular al plano de la tierra, la componente eléctrica de la onda es emitida perpendicularmente a dicho plano y, por lo tanto, se trabajará con polarización vertical. Además, el enlace transcurrirá sobre la superficie del mar que, por su salinidad, es muy conductiva. En estas condiciones, y dado que la altura de las antenas generalmente será muy inferior a la distancia entre el transmisor y el receptor, la incidencia será casi rasante, $\Psi \approx 0$, y resulta $|R|\approx1$ y $\beta=\pi$. Esto hará que si una onda polarizada verticalmente se refleja sobre dicha superficie, sufra un cambio de fase de 180 grados, o $\pi$ radianes.


%-------------------------------------------------------------------
\subsection{Modelo de propagación de tierra plana}
%-------------------------------------------------------------------
\label{cap4:sec:tierraPlana}
%-------------------------------------------------------------------
El modelo de tierra plana es aplicable a distancias cortas, para las que puede despreciarse la curvatura terrestre, y con terreno liso. 

Al operar a una frecuencia superior a 150 MHz, el efecto de onda de superficie puede despreciarse.

En la Figura~\ref{fig:cap4:2rayModel} se muestra el esquema de rayos de este modelo y los parámetros asociados:

\figura{Bitmap/Capitulo4/2rayModel}{width=.75\textwidth}{fig:cap4:2rayModel}%
{Esquema de rayos del modelo de propagación de tierra plana.}

\begin{itemize}
\item $T$: antena transmisora.
\item $T'$: reflejo geométrico de la antena transmisora.
\item $R$: antena receptora.
\item $h_{t}$: altura de la antena transmisora.
\item $h'_{t}$: altura de la antena transmisora reflejada. Es igual que $h_{t}$.
\item $h_{r}$: altura de la antena receptora.
\item $d$: distancia entre el transmisor y el receptor.
\item $\Psi$: ángulo de incidencia del rayo reflejado.
\item $RD$: rayo directo.
\item $RR$: rayo reflejado.
\end{itemize}

Mediante geometría básica se obtiene:

\textit{Ángulo de incidencia}:
\begin{equation}
\Psi = \arctan\left(\frac{h_{t} + h_{r}} {d} \right) 				\label{angInc}
\end{equation}

\textit{Diferencia de trayectos}:
\begin{equation}
\Delta l = TPR-TR=\sqrt{d_{2}+(h_{t}+h_{r})^{2}}-\sqrt{d_{2}+(h_{t}-h_{r})^{2}} \approx \frac{2h_{t}h_{r}}{d}		\label{difTray}
\end{equation}

\textit{Diferencia de fase}:
\begin{equation}
\Delta = \frac{4\pi h_{t} h_{r}}{\lambda d} 				\label{difFase}
\end{equation}

Si llamamos $e$ al módulo del campo, aplicando la ecuación~\ref{ecGpropagacion}, prescindiendo de su componente de onda de superficie, se tiene:
\begin{equation}
e = e_{0}\left| \left\{ 1 + |R| \cdot e^{-j(\Delta+\beta)} \right\} \right| =
    e_{0}\sqrt{1 + |R|^{2} + 2|R|\cos(\Delta+\beta)}				\label{propSinSup}
\end{equation}

La expresión~\ref{difFase} proporciona el valor de $\Delta$, y de las relaciones \ref{Rvertical} y \ref{Rhorizontal} se obtienen $|R|$ y $\beta$.

La pérdida básica de propagación será:
\begin{equation}
l_{b} = \left( \frac{4\pi d}{\lambda} \right)^{2} \cdot \left( \frac{e_{0}}{e} \right)^{2} =
	\frac{\left( \frac{4\pi d}{\lambda} \right)^{2}} {1 + |R|^{2} + 2|R|\cos(\Delta+\beta)}		\label{perdBasica}
\end{equation}

Como, en general, $\Psi=0$, dado que $h_{t}$ y $h_{r}$ son muy inferiores a $d$, resulta $|R|\approx1$ y $\beta=\pi$, por lo que:
\begin{equation}
e = e_{0}\sqrt{2(1-\cos\Delta)}=2e_{0}\left|\sin\frac{\Delta}{2}\right|=2e_{0}\left|\sin\frac{2\pi h_{t}h_{r}}{\lambda d}\right|	\label{propSinSup_corta}
\end{equation}

y

\begin{equation}
l_{b} = \frac{\left( \frac{4\pi d}{\lambda} \right)^{2}} {2(1-\cos\Delta)}		\label{perdBasica_corta}
\end{equation}

Del análisis de estas ecuaciones, \ref{propSinSup_corta} y \ref{perdBasica_corta}, se deduce que variarán de forma oscilatoria alrededor del valor en el espacio libre, $e_{0}$ y $l_{bf}$ respectivamente, generándose los denominados \textit{lóbulos de interferencia} entre el rayo directo y el rayo reflejado. Estas variaciones reflejan el hecho físico del refuerzo o cancelación del campo, según las ondas incidente y reflejada se sumen en concordancia o en oposición de fase.

\newpage

En la Figura~\ref{fig:cap4:twoRayPathLoss1} se representa la pérdida básica de propagación descritas por este modelo, ecuación \ref{perdBasica_corta}, en función de la distancia, para una frecuencia $f=869.525MHz$ y unas alturas de antena $h_{t}=h_{r}=2$ metros. Además, se incluye la pérdida básica de propagación en condiciones de espacio libre, pudiéndose observar la oscilación ya mencionada de la primera alrededor del valor en el espacio libre, hasta el punto $d = \frac {12h_{t}h_{r}}{\lambda}$.

\figura{Bitmap/Capitulo4/twoRayPathLoss1}{width=.82\textwidth}{fig:cap4:twoRayPathLoss1}%
{Pérdida básica de propagación descrita por el modelo de tierra plana.}

Los máximos de esta función se producen cuando el $\cos\Delta$ vale 1, anulando el denominador de la función, y haciéndola tender a infinito. Esto ocurre cuando:
\begin{equation}
\Delta=2n\pi \Longrightarrow d=\frac{2h_{t}h_{r}}{n\lambda}
\end{equation}

Los mínimos se producen cuando el $\cos\Delta$ toma el valor -1, haciendo máximo el denominador de la función. Esto sucede cuando:

\begin{equation}
\Delta = (2n+1)\pi \Longrightarrow d=\frac{4h_{t}h_{r}}{\lambda (2n+1)}
\end{equation}

Para $d = \frac {12h_{t}h_{r}}{\lambda}$, $e=e_{0}$ y para distancias mayores $e$ es ya siempre menor a $e_{0}$. Esta es la zona habitual de trabajo en los modelos de tierra plana. En ella el argumento del seno en \ref{propSinSup_corta} es muy pequeño, por lo que puede ponerse:

\begin{equation}
e = e_{0}\frac{4\pi h_{t}h_{r}}{\lambda d}		\label{propSinSup_supercorta}
\end{equation}

que es la fórmula habitualmente utilizada para la propagación en condiciones de tierra plana.

En este caso, la pérdida básica de propagación será:

\begin{equation}
l_{b}=\frac{d^{4}}{(h_{t}h_{r})^{2}}			\label{perdBasica_supercorta}
\end{equation}

y en dB:

\begin{equation}
L_{b}=40 \cdot log(d[km]) - 20 \cdot log(h_{t} \cdot h_{r}) + 120	\label{perdBasica_db}
\end{equation}

Es decir, resulta independiente de la frecuencia de la onda y decrece con la distancia a la cuarta, en vez de al cuadrado como sucede en condiciones de espacio libre.

En la Figura~\ref{fig:cap4:twoRayPathLoss2} se representan en función de la distancia, y utilizando la misma frecuencia y alturas que en el caso anterior:
\begin{itemize}
\item La pérdida básica de propagación en condiciones de estado libre, ecuación \ref{perdidasEspacioLibre}.
\item La pérdida básica de propagación del modelo de tierra plana, ecuación \ref{perdBasica_corta} en unidades logarítmicas.
\item La pérdida básica de propagación del modelo de tierra plana en su forma simplificada para distancias $d\geq \frac {12h_{t}h_{r}}{\lambda}$, ecuación \ref{perdBasica_db}. En este caso $d\geq 139.124$ metros. 
\end{itemize}

\figura{Bitmap/Capitulo4/twoRayPathLoss2}{width=.82\textwidth}{fig:cap4:twoRayPathLoss2}%
{Pérdida básica de propagación de varios modelos.}

En la Figura~\ref{fig:cap4:pr_twoRayModel} se evalúa la ecuación general de balance del enlace, expresión \ref{cap4:eq:balanceEnlace}, utilizando las pérdidas básicas de propagación descritas por el modelo de tierra plana, expresión \ref{perdBasica_corta}, y los valores: $f=869.525MHz$, $P_{t}=25dBm$, $G_{t}=G_{r}=4.5dBi$ y $h_{t}=h_{r}=2$ metros.

\figura{Bitmap/Capitulo4/pr_twoRayModel}{width=.82\textwidth}{fig:cap4:pr_twoRayModel}%
{Potencia disponible a la entrada del receptor en función de la distancia utilizando el modelo de tierra plana.}

Se observa que, en este caso, la distancia máxima a la que se podría lograr comunicación entre el transmisor y el receptor es de 5.6 kilómetros, menos de un 3\% del valor ideal calculado en condiciones de espacio libre. Aún así, este alcance obtenido sigue siendo un resultado teórico, en el que se supone el mar como una superficie lisa y no se contemplan otros factores que estarán presentes en el caso real, como: pérdidas de potencia en los equipos, variación de la altura relativa de las antenas, difracción por barcos u el propio oleaje, atenuación por gases o partículas en suspensión, etc.

Para profundizar en estos temas, se remite al lector al libro de \textit{Transmisión por radio} \citep{transmisionRadio}. El código utilizado para las simulaciones en MATLAB se incluye en el Apéndice~\ref{ap2:matlab}. También se propone la utilización de herramientas libres para el cálculo de enlaces de comunicación, como: \textit{Radio Mobile}\footnote{http://www.cplus.org/rmw/} o \textit{SPLAT!}\footnote{http://www.qsl.net/kd2bd/splat.html}.


%-------------------------------------------------------------------
\section{Implemetación de un enlace simple de datos en el mar}
%-------------------------------------------------------------------
\label{cap4:sec:implementacionEnlace}
%-------------------------------------------------------------------
Con el objetivo de determinar la distancia máxima a la que podrán situarse las boyas entre sí para formar la red ad hoc, se han realizado una serie de medidas de campo, que se detallan a continuación.

%-------------------------------------------------------------------
\subsection{Escenario}
%-------------------------------------------------------------------
\label{cap4:sec:escenario}
%-------------------------------------------------------------------
Se han implementado tres enlaces simples de datos. En todos los casos, tanto el nodo transmisor como el receptor se encontraban en tierra firme, pero situados de modo que prácticamente la totalidad del vano del enlace discurría sobre la superficie del mar. Concretamente, como se puede observar en la Figura~\ref{fig:cap4:enlaces}, uno de ellos estaba ubicado de manera permanente al final del espigón del Puerto Pesquero de Vilanova i la Geltrú, y el otro se situó en diferentes puntos de la costa logrando enlaces aproximados de: 2, 3 y 3.5 kilómetos.

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:enlace1}%
Enlace 1 de 1.84 km.}%
\includegraphics[width=0.9\textwidth]%
{Imagenes/Bitmap/Capitulo4/enlace1}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:enlace2}%
Enlace 2 de 3.06 km.}%
\includegraphics[width=0.9\textwidth]%
{Imagenes/Bitmap/Capitulo4/enlace2}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:enlace3}%
Enlace 3 de 3.45 km.}%
\includegraphics[width=0.9\textwidth]%
{Imagenes/Bitmap/Capitulo4/enlace3}%
\end{SubFloat}
\caption{Enlaces implementados en las medidas de campo.}
\label{fig:cap4:enlaces}
\end{figure}

\newpage

En la Tabla~\ref{cap4:tab:posicionNodos} se presentan las coordenadas geográficas y altura aproximada de cada uno de los puntos.

\begin{table}[h!]
\footnotesize
\centering
\scalebox{0.95}{
\begin{tabular}{| c | c | c | c | c | c |}
\hline
\hline
\textbf{Número de}	& \textbf{Posición del}	& \textbf{Altura aprox.}	& \textbf{Posición del}	& \textbf{Altura aprox.}	& \textbf{Distancia}	\\
\textbf{enlace}		& \textbf{nodo A}	& \textbf{del nodo A}		& \textbf{nodo B}	& \textbf{del nodo B}		& \textbf{(km)}		\\
\hline
\textbf{Enlace 1}	& 41.206017 N		& 2.5 m				& 41.207619 N		& 5 m				& 1.84			\\
			& 1.729322 E		&				& 1.70717 E	 	&				& 			\\
\hline
\textbf{Enlace 2}	& 41.206017 N		& 2.5 m				& 41.205603 N		& 2.5 m				& 3.06			\\
			& 1.729322 E		&				& 1.693043 E	 	& 	 			& 			\\
\hline
\textbf{Enlace 3}	& 41.206017 N 		& 2.5 m				& 41.204021 N		& 2.5 m				& 3.45			\\
			& 1.729322 E		& 				& 1.688182 E	 	&				& 			\\
\hline
\hline
\end{tabular}}
\caption{Posición y altura de los nodos en la implementación de los enlaces simples de datos.%
         \label{cap4:tab:posicionNodos}}
\end{table}


%-------------------------------------------------------------------
\subsection{Procedimiento}
%-------------------------------------------------------------------
\label{cap4:sec:procedimiento}
%-------------------------------------------------------------------
Se han empleado, para realizar las distintas medidas, dos módulos XBee-PRO 868 con su configuración por defecto de fábrica, salvo los siguientes parámetros:
\begin{itemize}
\item \textbf{RR - MAC Retries}. Tiene el valor 0. De esta manera cada paquete unicast sólo se envía una única vez, aunque no se reciba su correspondiente acuse de recibo (ACK).
\item \textbf{MT - Multiple Transmissions}. Con el valor 0. De esta manera cada paquete \mbox{broadcast} sólo se envía una única vez.
\item \textbf{PL - TX Power Level}. Utilizando el valor 4, equivalente a la máxima potencia, 25 dBm (315 mW).
\end{itemize} 

El nodo que realiza las medidas, al que se llamará nodo A, consiste en un ordenador portatil con el software X-CTU y un módulo XBee-PRO 868 conectado a él por el puerto USB. El nodo B, configurado en \textit{loopback}, utiliza únicamente una batería con salida USB para su alimentación.

Un paquete recibido con éxito implica que:
\begin{enumerate}
\item El nodo A lo envía, y llega correctamente al B.
\item El nodo B, al estar configurado en \textit{loopback}, retransmite el mismo paquete, y el A lo recibe correctamente, anotándolo como bueno.
\end{enumerate}

Por lo tanto, cada paquete recibido por el nodo A recorre dos veces el enlace, una de ida y otra de vuelta. Más adelante, se profundizará en este hecho. 

Concretamente, utilizando la herramienta \textit{Range Test}, incluida en el software X-CTU de Digi International, se ha medido:
\begin{itemize}
\item El porcentaje de paquetes recibidos con éxito. Para ello, se envian desde el nodo A tandas de 100 paquetes, midiendo el número de ellos que regresan correctamente. Se han empleado paquetes de 50 bytes de tamaño, y un timeout de recepción de paquete de 1.5 segundos, en el nodo A. 
\item El nivel de potencia de señal recibida o RSSI. Para ello, se selecciona la opción en el software y se envían paquetes anotando, en caso de que se reciban con éxito, su nivel de RSSI.
\end{itemize}

Cada una de estas dos medidas se ha repetido 5 veces en cada uno de los 3 enlaces. Además, se han realizado dos jornadas de medida, una el día 29 de Junio y la otra el 13 de Julio de 2011. Ambos días, el mar estaba tranquilo, con un oleaje débil, temperatura del agua de 22-25ºC, temperatura ambiente 26-28ºC y humedad aproximada del 75\%.


%-------------------------------------------------------------------
\subsection{Medidas}
%-------------------------------------------------------------------
\label{cap4:sec:medidas}
%-------------------------------------------------------------------
Para las medidas se empleó el equipo ya mencionado, con: $P_{t}=25dBm$, $G_{t}=4.5dBi$, $G_{r}=4.5dBi$. Las alturas de las antenas se indican en la Tabla~\ref{cap4:tab:posicionNodos}. En la Figura~\ref{fig:cap4:nodosEnlaces} se muestra una imagen de cada uno de los nodos en su posición.

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:nodoA}%
Nodo A.}%
\includegraphics[width=0.45\textwidth]%
{Imagenes/Bitmap/Capitulo4/nodoA}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:nodoBe1}%
Nodo B en el enlace 1.}%
\includegraphics[width=0.45\textwidth]%
{Imagenes/Bitmap/Capitulo4/nodoBe1}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:nodoBe2}%
Nodo B en el enlace 2.}%
\includegraphics[width=0.45\textwidth]%
{Imagenes/Bitmap/Capitulo4/nodoBe2}%
\end{SubFloat}
\qquad
\begin{SubFloat}
{\label{fig:cap4:nodoBe3}%
Nodo B en el enlace 3.}%
\includegraphics[width=0.45\textwidth]%
{Imagenes/Bitmap/Capitulo4/nodoBe3}%
\end{SubFloat}
\caption{Nodos en los distintos enlaces.}
\label{fig:cap4:nodosEnlaces}
\end{figure}

En la Tabla~\ref{cap4:tab:medidasCampo} se muestran los resultados de las medidas realizadas. Concretamente de las 5 anotadas en cada caso se indican: los valores mayor y menor, y la media de todas.

\begin{table}[t]
\footnotesize
\centering
\scalebox{0.95}{
\begin{tabular}{| c | c | c c c | c c c |}
\hline
\hline
\textbf{Número de}	& \textbf{Jornada}	& \multicolumn{3}{|c|}{\textbf{Porcentaje de paquetes}} & \multicolumn{3}{|c|}{\textbf{RSSI}} 		  \\
\textbf{enlace}		& 			& \multicolumn{3}{|c|}{\textbf{recibidos correctamente}}& \multicolumn{3}{|c|}{\textbf{(dBm)}}		  \\
\hline
			&			& \textbf{Min.}	& \textbf{Media} & \textbf{Max.}        & \textbf{Min.} & \textbf{Media} & \textbf{Max.}  \\
\hline
& & & & & & & \\ 
\textbf{Enlace 1}		& Jornada 1 			& 83\%		& 92\%		& 100\%		& -103		& -96.8 	& -93 		\\
\multirow{3}{*}{\textbf{(2 km)}}& 				&		& 		&		& 		& 		&		\\
				& Jornada 2			& 82\%		& 91.4\%	& 98\%		& -102		& -96.8		& -92 		\\
				&				&		& 		& 		& 		& 		&		\\
\hline
& & & & & & & \\
\textbf{Enlace 2}		& Jornada 1 			& -		& -		& -		& -		& -	 	& - 		\\
\multirow{3}{*}{\textbf{(3 km)}}& 				&		& 		&		& 		& 		&		\\
				& Jornada 2			& -		& -		& -		& -		& -		& - 		\\
				&				&		& 		& 		& 		& 		&		\\
\hline
& & & & & & & \\
\textbf{Enlace 3}		& Jornada 1 			& -		& -		& -		& -		& -		& - 		\\
\multirow{3}{*}{\textbf{(3.5 km)}}& 				&		& 		&		& 		& 		&		\\
				& Jornada 2			& -		& -		& -		& -		& -		& - 		\\
				&				&		& 		& 		& 		& 		&		\\
\hline
\hline
\end{tabular}}
\caption{Medidas de porcentaje de paquetes recibidos correctamente y RSSI realizadas para varios enlaces sobre el mar.%
         \label{cap4:tab:medidasCampo}}
\end{table}

Como se observa, únicamente se consiguió comunicación en el primer enlace, con una distancia del enlace de 1.84 kilómetros. En los demás casos no se registró ningún paquete en el nodo A, a pesar de realizar numeroso intentos: desplazando el nodo B, aproximándolo a la orilla, elevándolo, etc.

\newpage

%-------------------------------------------------------------------
\subsection{Análisis de probabilidad}
%-------------------------------------------------------------------
\label{cap4:sec:probabilidad}
%-------------------------------------------------------------------
Una de las opciones que permite el firmware de los módulos XBee-PRO 868 es determinar el número de reintentos de envío de paquete a nivel de MAC. Concrétamente, se pueden definir en los parámetros de configuración \textit{MAC Retries (RR)} para paquetes unicast, y \textit{Multiple Transmissions (MT)} para broadcast. En las pruebas realizadas estos valores se encontraban a 0, es decir, cada paquete se enviaba una única vez, llegase o no con éxito.

De la Tabla~\ref{cap4:tab:medidasCampo} se puede determinar que, para el primer enlace, la probabilidad de recibir un paquete correctamente es aproximadamente del 92\%. Como ya se comentó anteriormente, por el método de medida utilizado, esto implica que el paquete haya recorrido dos veces el enlace, una de ida ($ A \to B$) y otra de vuelta ($ B \to A$). Por lo tanto, si se define:
\begin{itemize}
\item $P_{AA}$: probabilidad de que un paquete realice la ida y la vuelta correctamente. Este sería el valor medido con el procedimiento utilizado, que para el enlace 1 es el 92\%.
\item $P_{AB}$: probabilidad de que un paquete del nodo A sea recibido con éxito por el B.
\item $P_{BA}$: probabilidad de que un paquete del nodo B sea recibido con éxito por el A.
\end{itemize}
, la relación entre ellas será:

\begin{equation}
P_{AA} = P_{AB} \cdot P_{BA}
\end{equation}

Si se considera $P_{AB} = P_{BA}$, entonces:

\begin{equation}
P_{AA} = P_{AB}^{2}
\end{equation}
, por lo tanto:
\begin{equation}
P_{AB} = P_{BA} = \sqrt{P_{AA}} = 96\%
\end{equation}

Si se quiere garantizar que un paquete del nodo A al B llegue correctamente con una probabilidad de éxito, $P_{E} \geq 99\%$, sea $n$ el número de reintentos a nivel de MAC de envío del paquete, entonces:
\begin{equation}
P_{E} = 1 - \left(1 - P_{AB}\right)^{n}
\end{equation}

Por ello, el número de reintentos $n$ será el entero superior del resultado de esta expresión:
\begin{equation}
n = \frac {\log_{10}\left(1-P_{E}\right)} {\log_{10}\left(1-P_{AB}\right)} = 
	\frac {\log_{10}\left(1-P_{E}\right)} {\log_{10}\left(1-\sqrt{P_{AA}}\right)} = 1.43 \to 2
\end{equation}

Y de esta manera:
\begin{equation}
P_{E} = 1 - \left(1 - P_{AB}\right)^{n} = 1 - \left(1 - 0.96\right)^{2} = 0.9984 \to 99.84\%
\end{equation}


%-------------------------------------------------------------------
\section{Discusión de resultados}
%-------------------------------------------------------------------
\label{cap4:sec:discusionResultados}
En la Figura~\ref{fig:cap4:measurements1} se muestran las medidas realizadas en comparación con el caso teórico del modelo de tierra plana. Se observa que la mayoría de ellas se encuentran a más de 10 dB por debajo del valor teórico. Además, las diferencias entre el valor máximo y mínimo medidos en un mismo punto son de hasta 10 dB. Como se comentó en el Capítulo 2, existen casos similares en los que para distancias superiores a 750 metros estas variaciones alcanzaban hasta 25 dB \citep{experimentalBuoy}.

\figura{Bitmap/Capitulo4/measurements1}{width=.82\textwidth}{fig:cap4:measurements1}%
{Medidas realizadas de potencia disponible en el receptor para en enlace 1.}

Como se reseñó en la Subsección~\ref{cap4:sec:tierraPlana}, el modelo de tierra plana supone el mar como una superficie lisa y no contempla otros factores que están presentes en el caso real, como: pérdidas de potencia en los equipos, difracción por barcos u el propio oleaje, atenuación por gases o partículas en suspensión, etc. Estos efectos no conteplados, en base a las medidas realizadas, se pueden cuantificar en una reducción de la potencia recibida de entre 8 y 19 dB, valores muy considerables.

Si se desplazan las medidas realizadas a las distancias equivalentes de los enlaces 2 y 3, manteniendo siempre la misma diferencia con el caso teórico (ver Figura~\ref{fig:cap4:medidasHipoteticas}), se observa que algunos valores todavía se encuentran por encima de la sensibilidad del receptor. Por lo tanto, se tendría que haber registrado algún paquete como recibido, pero esto no fué así en ningún caso. Por ello, se afirma que la reducción de entre 8 y 19 dB sobre la potencia disponible en el receptor teórica aumenta con la distancia; siendo en el enlace 2, de 3 kilómetros, superior a 11 dB en todas las medidas. Este efecto también puede atribuirse a la variación de la altura de la antena del nodo B, que en los enlaces 2 y 3 es menor que en el primero.

\begin{figure}[h!]
\centering
%
\begin{SubFloat}
{\label{fig:cap4:measurements2}%
Medidas hipotéticas en el enlace 2.}%
\includegraphics[width=0.8\textwidth]%
{Imagenes/Bitmap/Capitulo4/measurements2}%
\end{SubFloat}
\begin{SubFloat}
{\label{fig:cap4:measurements3}%
Medidas hipotéticas en el enlace 3.}%
\includegraphics[width=0.8\textwidth]%
{Imagenes/Bitmap/Capitulo4/measurements3}%
\end{SubFloat}
\caption{Medidas hipotéticas de potencia recibida en los enlaces 2 y 3.}
\label{fig:cap4:medidasHipoteticas}
\end{figure}

Se recuerda que existen experiencias publicadas en las que, con los mismos módulos \mbox{XBee-PRO 868} situados en boyas a una altura de 1.5 m sobre el nivel del mar, se llegaron a implementar enlaces de hasta 3 kilómetros. \citep{sieber2}

Por otra parte, \citet{experimentalSimulationWimax} realizan una campaña extensa de medidas en entorno marino y sus resultados se ajustan al caso teórico del modelo de tierra plana con una diferencia menor de 2 dB. 

En base a lo comentado, se propone repetir las medidas sobre tierra firme para tratar de determinar el efecto que produce el mar. Además, también sería conveniente realizar una campaña de medidas empleando una embarcación, pudiendo registrar datos durante todo el trayecto hasta la pérdida de comunicación entre nodos. Por último, se propone modificar el número de repeticiones a nivel de mac, acorde a la Subsección~\ref{cap4:sec:probabilidad}, y determinar así si el análisis probabilístico realizado se ve reflejado, o no, en la realidad.


% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
